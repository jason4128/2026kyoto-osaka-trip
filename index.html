<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ªæ—…éŠè¦åŠƒ ğŸ¯ - ç¦ªæ„å”ä½œç‰ˆï¼ˆæ”¯æ´ç´°ç·»åˆ†å¸³ï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOxm1LPBq5L9JdZH4gaS1b4DYGc6CME_o",
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.firebasestorage.app",
            messagingSenderId: "473684537567",
            appId: "1:473684537567:web:52b103a59e678bd478b96a",
            measurementId: "G-BETXRCZPMH"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.ref = ref;
        window.onValue = onValue;
        window.set = set;
        window.firebaseConfig = firebaseConfig;

        window.startAppLogic();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body { font-family: 'Noto Sans TC', 'Inter', sans-serif; background-color: #fffbeb; color: #333; }
        [contenteditable]:focus { outline: 2px solid #f472b6; background-color: #fff7fa; }
        .table-cell { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; min-height: 48px; line-height: 1.5; }
        .header-cell { background: linear-gradient(135deg, #fbcfe8, #f472b6); color: #444; position: sticky; top: 0; z-index: 10; padding: 12px; }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { background-color: white; color: #be185d; border-top: 3px solid #be185d; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-bottom: 1px solid white; }
        .tab-inactive { background-color: #f3f4f6; color: #78716c; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; }
        .flatpickr-input[data-input] { opacity: 0; position: absolute; pointer-events: none; z-index: -1; }
        .flatpickr-input { border: none !important; padding: 0 !important; outline: none !important; background: transparent !important; box-shadow: none !important; cursor: pointer; width: 100%; }
        .date-time-container { position: relative; }
        .w-16 { min-width: 64px; } .w-20 { min-width: 80px; } .w-32 { min-width: 128px; } .w-48 { min-width: 192px; } .w-28 { min-width: 112px; } .w-64 { min-width: 256px; }
        @media (max-width: 768px) { .table-cell { padding: 8px 4px !important; font-size: 12px; } .header-cell { font-size: 12px; padding: 8px 4px; } .overflow-x-auto { overflow-x: scroll; -webkit-overflow-scrolling: touch; } }
        @media (max-width: 640px) { .table-cell { padding: 6px 2px !important; font-size: 11px !important; min-width: 60px !important; } #itineraryTable th { font-size: 10px !important; padding: 8px 2px !important; } .header-cell { padding: 6px 2px !important; font-size: 9px !important; } }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        <header class="p-6 bg-gradient-to-r from-pink-100 to-yellow-50 rounded-t-xl border-b border-rose-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ªæ—…éŠè¦åŠƒ ğŸ¯</h1>
            <p class="text-rose-600 text-sm">âœ¨ è‡ªå‹•æ’åºè¡Œç¨‹ | ğŸ“… æ—¥æ›†å¼æ—¥æœŸé¸æ“‡ | å³æ™‚ç´°ç·»åˆ†å¸³</p>
            <div class="flex items-center justify-between mt-2">
                <span id="syncStatus" class="sync-status text-green-600 text-xs font-semibold">ğŸ”´ æ­£åœ¨é€£æ¥...</span>
                <span class="text-xs text-rose-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">ğŸ“… è¡Œç¨‹è¡¨</div>
            <div id="wishlist-tab" class="tab tab-inactive ml-2" onclick="showPage('wishlist')">ğŸ’¡ å¾…å®šæ¸…å–®</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">ğŸ’° åˆ†å¸³è¡¨ (6äºº)</div>
        </div>

        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY åŒ¯ç‡:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView(); saveData()"
                           title="å³æ™‚åŒ¯ç‡">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-rose-300 text-gray-800 px-3 py-1 rounded text-sm hover:bg-rose-400 transition">ğŸ”„ æ›´æ–°</button>
            </div>

            <div id="itinerary-actions" class="">
                <button onclick="addRow(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition text-sm">+ æ–°å¢è¡Œç¨‹</button>
            </div>

            <div id="wishlist-actions" class="hidden">
                <button onclick="addWishlistItem(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition text-sm">+ æ–°å¢æƒ³æ³•</button>
            </div>

            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ ç™»è¼‰æ”¯å‡º</button>
                <button onclick="togglePersonEditModal(); saveData()" class="bg-rose-300 hover:bg-rose-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow text-sm">ğŸ‘¤ ç·¨è¼¯äººå</button>
            </div>
        </div>

        <!-- è¡Œç¨‹è¡¨è¦–åœ–ï¼ˆå®Œå…¨ä¸è®Šï¼‰ -->
        <div id="itinerary-view" class="p-4 sm:p-6">
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center space-x-2">
                    <label for="dayFilter" class="text-sm font-medium text-gray-700">é¡¯ç¤ºæ—¥æœŸ:</label>
                    <select id="dayFilter" onchange="filterItinerary(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm w-48 bg-white">
                        <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                    </select>
                </div>
                <div class="flex gap-4 text-sm font-bold text-gray-800">
                    <div class="bg-pink-100 p-2 rounded-md">ç¸½è¨ˆ (JPY): <span id="totalEstimatedJpy" class="text-red-600">0 JPY</span></div>
                    <div class="bg-pink-100 p-2 rounded-md">ç¸½è¨ˆ (TWD): <span id="totalEstimatedTwd" class="text-red-800">0 TWD</span></div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-28">æ—¥æœŸ/æ™‚é–“</th>
                            <th class="header-cell w-48">åœ°é»</th>
                            <th class="header-cell w-32">äº¤é€š</th>
                            <th class="header-cell w-28">åœ°åœ–</th>
                            <th class="header-cell w-32 text-right">ğŸ’° é ç®—</th>
                            <th class="header-cell w-48 rounded-tr-xl">å‚™è¨»</th>
                            <th class="header-cell w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    <tfoot>
                        <tr class="bg-gradient-to-r from-pink-50 to-amber-50 text-base font-bold text-gray-800">
                            <td colspan="4" class="table-cell text-right py-4">æ‰€é¸æ—¥æœŸç¸½è¨ˆ:</td>
                            <td class="table-cell py-4 text-sm">
                                <div class="text-red-600 mb-1" id="filteredTotalJpy">0 JPY</div>
                                <div class="text-red-800" id="filteredTotalTwd">0 TWD</div>
                            </td>
                            <td colspan="2" class="table-cell py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- å¾…å®šæ¸…å–®è¦–åœ–ï¼ˆå®Œå…¨ä¸è®Šï¼‰ -->
        <div id="wishlist-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’¡ å¾…å®šæ™¯é»/ç¾é£Ÿ/è³¼ç‰©æ¸…å–®</h2>
            <p class="text-sm text-gray-600 mb-4">é»æ“Šã€Œæ„›å¿ƒã€æŠ•ç¥¨è¡¨ç¤ºå°è©²é …ç›®æœ‰èˆˆè¶£ï¼</p>
            <div class="overflow-x-auto shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-16">é¡åˆ¥</th>
                            <th class="p-3 w-40">åç¨±</th>
                            <th class="p-3 w-48">åœ°é»/é€£çµ</th>
                            <th class="p-3 w-20 text-center">å„ªå…ˆç´š</th>
                            <th class="p-3 w-32">æè­°äºº</th>
                            <th class="p-3 w-48">å‚™è¨»</th>
                            <th class="p-3 w-16 text-center">â¤ï¸ æŠ•ç¥¨</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- åˆ†å¸³è¡¨è¦–åœ–ï¼ˆå·²å‡ç´šï¼‰ -->
        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’µ æ”¯å‡ºç™»è¼‰è¡¨</h2>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">é …ç›®åç¨±</th>
                            <th class="p-3 w-40 text-right">é‡‘é¡</th>
                            <th class="p-3 w-28">å¹£åˆ¥</th>
                            <th class="p-3 w-32">ä»˜æ¬¾äºº</th>
                            <th class="p-3 w-64">åƒèˆ‡åˆ†æ”¤çš„äºº</th>
                            <th class="p-3 w-40 text-right">å°å¹£é‡‘é¡</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">âš–ï¸ å³æ™‚çµç®—çµæœ</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ”„ è½‰å¸³æ¸…å–® (èª°è©²ä»˜èª°)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-pink-50 text-gray-800"></div>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ï¼ˆå®Œå…¨è·Ÿä½ åŸæœ¬ä¸€æ¨£ï¼‰ ===
        let EXCHANGE_RATE = 22.50;
        const DEFAULT_PEOPLE = ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'];
        let PEOPLE = DEFAULT_PEOPLE;
        let itineraryData = [];
        let expenses = [];
        let wishlistData = [];
        let currentPage = 'itinerary';
        let currentFilterDay = 'all';

        let db, ref, onValue, set;

        const DEFAULT_ITINERARY = [
            { day: "2026-03-20", time: "08:00", location: "æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)", travelTime: "æ©Ÿå ´å¿«ç·š", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "åœ¨æ©Ÿå ´è³¼è²· ICOCA/HARUKA" },
            { day: "2026-03-20", time: "11:00", location: "äº¬éƒ½ï¼šé£¯åº— Check-in", travelTime: "é›»è»Š/åœ°éµ", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "å…ˆå¯„æ”¾è¡Œæï¼Œä¸‹åˆé–‹å§‹è¡Œç¨‹" },
            { day: "2026-03-20", time: "14:00", location: "æ¸…æ°´å¯º", travelTime: "å…¬è»Š", mapLink: "", estimatedAmount: 400, budgetCurrency: 'JPY', notes: "é–€ç¥¨" },
            { day: "2026-03-21", time: "09:30", location: "åµå±±ï¼šç«¹æ—å°å¾‘", travelTime: "JR/åµé›»", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "æ—©é»å»é¿é–‹äººæ½®" },
            { day: "2026-03-21", time: "12:30", location: "åµå±±ï¼šåˆé¤ (æ¹¯è±†è…)", travelTime: "æ­¥è¡Œ", mapLink: "", estimatedAmount: 3000, budgetCurrency: 'JPY', notes: "é è¨ˆé«˜åƒ¹ä½åˆé¤" },
            { day: "2026-03-22", time: "10:00", location: "å¤§é˜ªåŸ", travelTime: "JR", mapLink: "", estimatedAmount: 600, budgetCurrency: 'JPY', notes: "å¤©å®ˆé–£é–€ç¥¨" },
        ];

        window.startAppLogic = function() {
            db = window.db;
            ref = window.ref;
            onValue = window.onValue;
            set = window.set;

            console.log("Firebase App å·²åˆå§‹åŒ–ï¼ŒDatabase URL:", window.firebaseConfig.databaseURL);
            startDataListener();
            window.restoreDefaultData = restoreDefaultData;
        };

        function restoreDefaultData() {
            if (!confirm('ç¢ºå®šè¦è¦†è“‹è³‡æ–™åº«ä¸¦å¯«å…¥é è¨­è¡Œç¨‹ï¼Ÿ')) return;
            set(ref(db, '/'), {
                itinerary: DEFAULT_ITINERARY,
                expenses: [],
                wishlist: [],
                people: PEOPLE,
                rate: EXCHANGE_RATE
            }).then(() => alert("é è¨­è³‡æ–™å·²å¯«å…¥ï¼è«‹é‡æ–°æ•´ç†é é¢ã€‚"));
        }

        function startDataListener() {
            onValue(ref(db, '/'), (snapshot) => {
                const data = snapshot.val() || {};
                itineraryData = data.itinerary || [];
                expenses = data.expenses || [];
                wishlistData = data.wishlist || [];
                PEOPLE = data.people || DEFAULT_PEOPLE;
                EXCHANGE_RATE = data.rate || 22.50;

                document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');

                if (currentPage === 'itinerary') {
                    renderDayFilter();
                    renderTable();
                }
                if (currentPage === 'split') renderSplitView();
                if (currentPage === 'wishlist') renderWishlistTable();

                calculateTotals();
                calculateAndRenderSettlement();
                document.getElementById('syncStatus').className = 'text-green-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = 'ğŸŸ¢ å³æ™‚åŒæ­¥ä¸­';
            }, (error) => {
                console.error("Firebase æ•¸æ“šç›£è½å¤±æ•—:", error);
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = `ğŸ”´ é€£ç·šå¤±æ•— (${error.code})`;
            });
        }

        function saveData() {
            document.getElementById('syncStatus').className = 'text-gray-500 text-xs font-semibold';
            document.getElementById('syncStatus').textContent = 'ğŸŸ¡ åŒæ­¥ä¸­...';
            const dataToSave = {
                itinerary: itineraryData,
                expenses: expenses,
                wishlist: wishlistData,
                people: PEOPLE,
                rate: EXCHANGE_RATE
            };
            set(ref(db, '/'), dataToSave);
        }

        // ä»¥ä¸‹æ‰€æœ‰å‡½æ•¸ï¼ˆè¡Œç¨‹è¡¨ã€å¾…å®šæ¸…å–®ã€åŒ¯ç‡ç­‰ï¼‰éƒ½è·Ÿä½ åŸæœ¬å®Œå…¨ä¸€æ¨£
        // æˆ‘åªè²¼å‡ºæœ‰æ”¹å‹•çš„åˆ†å¸³éƒ¨åˆ†ï¼Œçœç•¥é‡è¤‡å…§å®¹

        // === åˆ†å¸³åŠŸèƒ½ï¼ˆå·²å‡ç´šï¼‰ ===
        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num * EXCHANGE_RATE) : Math.round(num);
        }

        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';

            expenses.forEach(expense => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150';

                let cell = row.insertCell();
                cell.className = 'p-3 table-cell w-48';
                cell.contentEditable = true;
                cell.textContent = expense.name || 'æ–°æ”¯å‡º';
                cell.onblur = (e) => updateExpenseField(expense.id, 'name', e.target.innerText);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-40 text-right';
                cell.innerHTML = `
                    <input type="number" value="${expense.amount || 0}" min="0"
                           class="text-input block text-right font-semibold text-sm p-1 border-b w-full"
                           oninput="handleAmountInput('${expense.id}', this.value)"
                           onblur="finalizeAmountUpdate('${expense.id}', this.value)"
                           placeholder="0">
                `;

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-28';
                cell.innerHTML = createCurrencySelect(expense.id, expense.currency);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-32';
                cell.innerHTML = createPayerSelect(expense.id, expense.payer);

                // æ–°å¢ï¼šåƒèˆ‡åˆ†æ”¤çš„äºº
                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-64';
                const div = document.createElement('div');
                div.className = 'flex flex-wrap gap-2';
                PEOPLE.forEach(person => {
                    const checked = expense.participants?.[person] !== false;
                    div.innerHTML += `
                        <label class="flex items-center text-sm cursor-pointer">
                            <input type="checkbox" ${checked ? 'checked' : ''} 
                                   onchange="toggleParticipant('${expense.id}', '${person}', this.checked)"
                                   class="mr-1">
                            ${person}
                        </label>
                    `;
                });
                cell.appendChild(div);

                const twdEq = calculateTwdEquivalent(expense.amount, expense.currency);
                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-40 text-right font-bold text-red-700';
                cell.textContent = twdEq.toLocaleString() + ' TWD';

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-16 text-center';
                cell.innerHTML = `<button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });

            calculateAndRenderSettlement();
        }

        function toggleParticipant(expenseId, person, checked) {
            const index = expenses.findIndex(e => e.id === expenseId);
            if (index > -1) {
                if (!expenses[index].participants) {
                    expenses[index].participants = {};
                    PEOPLE.forEach(p => expenses[index].participants[p] = true);
                }
                expenses[index].participants[person] = checked;
                saveData();
                calculateAndRenderSettlement();
            }
        }

        function addExpense() {
            const newId = Date.now().toString();
            const defaultParticipants = {};
            PEOPLE.forEach(p => defaultParticipants[p] = true);

            expenses.push({
                id: newId,
                name: "æ–°å¢æ”¯å‡ºé …ç›®",
                amount: 0,
                currency: 'JPY',
                payer: PEOPLE[0] || 'Aå›',
                participants: defaultParticipants
            });
            saveData();
            renderSplitView();
        }

        function deleteExpense(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                renderSplitView();
            }
        }

        function updateExpenseField(id, field, value) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index][field] = value.trim();
                saveData();
            }
        }

        function handleAmountInput(id, value) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index].amount = parseFloat(value) || 0;
                calculateAndRenderSettlement();
            }
        }

        function finalizeAmountUpdate(id, value) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index].amount = parseFloat(value) || 0;
                saveData();
            }
        }

        function updateExpenseCurrency(id, currency) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index].currency = currency;
                saveData();
            }
        }

        function updateExpensePayer(id, payer) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index].payer = payer;
                saveData();
            }
        }

        function createCurrencySelect(id, current) {
            return `
                <select onchange="updateExpenseCurrency('${id}', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
                    <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                </select>
            `;
        }

        function createPayerSelect(id, current) {
            const options = PEOPLE.map(p => `<option value="${p}" ${current === p ? 'selected' : ''}>${p}</option>`).join('');
            return `
                <select onchange="updateExpensePayer('${id}', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        function calculateAndRenderSettlement() {
            const totalTWD = expenses.reduce((sum, e) => sum + calculateTwdEquivalent(e.amount, e.currency), 0);

            const netBalance = PEOPLE.reduce((acc, p) => { acc[p] = 0; return acc; }, {});

            expenses.forEach(e => {
                const twd = calculateTwdEquivalent(e.amount, e.currency);
                if (e.payer) netBalance[e.payer] += twd;
            });

            expenses.forEach(e => {
                const twd = calculateTwdEquivalent(e.amount, e.currency);
                const participants = e.participants || {};
                const active = PEOPLE.filter(p => participants[p] !== false);
                const num = active.length || 1;
                const share = twd / num;
                active.forEach(p => netBalance[p] -= share);
            });

            let creditors = [], debtors = [];
            for (const p in netBalance) {
                const bal = Math.round(netBalance[p]);
                if (bal > 1) creditors.push({ name: p, amount: bal });
                else if (bal < -1) debtors.push({ name: p, amount: -bal });
            }

            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);

            let settlements = [];
            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                const c = creditors[i];
                const d = debtors[j];
                const amt = Math.min(c.amount, d.amount);
                settlements.push({ from: d.name, to: c.name, amount: amt });
                c.amount -= amt;
                d.amount -= amt;
                if (c.amount <= 1) i++;
                if (d.amount <= 1) j++;
            }

            const summaryDiv = document.getElementById('settlement-summary');
            summaryDiv.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg text-blue-700">ç¸½æ”¯å‡º (TWD)</h3>
                    <p class="text-2xl font-extrabold text-blue-900">${totalTWD.toLocaleString()} TWD</p>
                </div>
                <div class="bg-pink-100 p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg text-pink-700">å€‹äººçµé¤˜</h3>
                    <ul class="text-sm font-semibold space-y-1">
                        ${PEOPLE.map(p => {
                            const bal = Math.round(netBalance[p]);
                            const color = bal > 0 ? 'text-green-600' : (bal < 0 ? 'text-red-600' : 'text-gray-600');
                            const sign = bal > 0 ? '+' : '';
                            return `<li>${p}: <span class="${color}">${sign}${bal.toLocaleString()} TWD</span></li>`;
                        }).join('')}
                    </ul>
                </div>
            `;

            const listDiv = document.getElementById('settlement-list');
            if (settlements.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500">âœ… æ”¶æ”¯å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</p>';
            } else {
                listDiv.innerHTML = settlements.map(s => `
                    <div class="flex items-center justify-between p-2 bg-white rounded-md shadow-sm border-l-4 border-rose-400">
                        <span class="text-sm font-medium">
                            <strong class="text-red-600">${s.from}</strong> æ‡‰ä»˜çµ¦
                            <strong class="text-green-600">${s.to}</strong>
                        </span>
                        <span class="font-bold text-lg text-rose-800">${s.amount.toLocaleString()} TWD</span>
                    </div>
                `).join('');
            }
        }

        // ä»¥ä¸‹æ‰€æœ‰å‡½æ•¸ï¼ˆè¡Œç¨‹è¡¨ã€å¾…å®šæ¸…å–®ã€åŒ¯ç‡ç­‰ï¼‰éƒ½è·Ÿä½ åŸæœ¬å®Œå…¨ä¸€æ¨£ï¼Œæˆ‘çœç•¥é‡è¤‡è²¼ä¸Š
        // åªè¦æŠŠä¸Šé¢çš„ <script> æ•´å€‹æ›¿æ›æ‰åŸæœ¬çš„å°±è¡Œ

        function renderDayFilter() {
            const filterSelect = document.getElementById('dayFilter');
            const allDays = itineraryData.map(item => item.day).filter(day => day && day.match(/^\d{4}-\d{2}-\d{2}$/));
            const uniqueDays = [...new Set(allDays)].sort();
            let options = '<option value="all">æ‰€æœ‰æ—¥æœŸ</option>';
            uniqueDays.forEach(day => {
                const displayDay = day.substring(5).replace('-', '/');
                options += `<option value="${day}" ${day === currentFilterDay ? 'selected' : ''}>${displayDay}</option>`;
            });
            filterSelect.innerHTML = options;
            if (currentFilterDay !== 'all' && !uniqueDays.includes(currentFilterDay)) {
                currentFilterDay = 'all';
                filterSelect.value = 'all';
            }
        }

        function filterItinerary(selectedDay) {
            currentFilterDay = selectedDay;
            renderTable();
            calculateTotals();
        }

        function renderTable() {
            const tbody = document.getElementById('itineraryBody');
            tbody.innerHTML = '';
            const filteredData = itineraryData.filter(item => currentFilterDay === 'all' || item.day === currentFilterDay);
            filteredData.sort((a, b) => {
                const dateTimeA = (a.day || '9999-12-31') + (a.time || '23:59');
                const dateTimeB = (b.day || '9999-12-31') + (b.time || '23:59');
                return dateTimeA.localeCompare(dateTimeB);
            });

            const columns = [
                { key: 'dateTime', class: 'font-bold w-28' },
                { key: 'location', editable: true, class: 'w-48' },
                { key: 'travelTime', editable: true, class: 'w-32' },
                { key: 'mapLink', editable: false, class: 'w-28' },
                { key: 'estimatedJpy', class: 'text-red-500 text-right w-32' },
                { key: 'notes', editable: true, isHtml: true, class: 'w-48' }
            ];

            filteredData.forEach((item, index) => {
                const originalIndex = itineraryData.findIndex(d => d === item);
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.setAttribute('data-original-index', originalIndex);

                columns.forEach(field => {
                    const cell = row.insertCell();
                    cell.className = `table-cell ${field.class || ''}`;

                    if (field.key === 'dateTime') {
                        let dayValue = item.day || '';
                        let timeValue = item.time || '';
                        cell.innerHTML = `
                            <div class="date-time-container">
                                <input type="text" id="date-${originalIndex}" value="${dayValue}" class="flatpickr-input block text-base font-bold w-full mb-1" placeholder="æœˆ/æ—¥">
                                <input type="text" id="time-${originalIndex}" value="${timeValue}" class="flatpickr-input block text-sm text-gray-600 w-full" placeholder="HH:MM">
                            </div>
                        `;
                        setTimeout(() => {
                            flatpickr(document.getElementById(`date-${originalIndex}`), {
                                locale: 'zh',
                                dateFormat: "Y-m-d",
                                defaultDate: dayValue.match(/^\d{4}-\d{2}-\d{2}$/) ? dayValue : null,
                                disableMobile: true,
                                altInput: true,
                                altFormat: "m/d",
                                altInputClass: "flatpickr-input block text-base font-bold w-full mb-1",
                                onChange: (selectedDates, dateStr) => {
                                    itineraryData[originalIndex].day = dateStr;
                                    saveData();
                                    renderTable();
                                }
                            });
                            flatpickr(document.getElementById(`time-${originalIndex}`), {
                                locale: 'zh',
                                enableTime: true,
                                noCalendar: true,
                                disableMobile: true,
                                dateFormat: "H:i",
                                altInput: true,
                                altFormat: "H:i",
                                altInputClass: "flatpickr-input block text-sm text-gray-600 w-full",
                                onChange: (selectedDates, dateStr) => {
                                    itineraryData[originalIndex].time = dateStr;
                                    saveData();
                                    renderTable();
                                }
                            });
                        }, 0);
                    } else if (field.key === 'estimatedJpy') {
                        const amount = item.estimatedAmount || 0;
                        const currency = item.budgetCurrency || 'JPY';
                        cell.innerHTML = `
                            <div class="flex flex-col items-end gap-1">
                                <input type="number" value="${amount}" min="0" class="text-input block text-right font-semibold text-sm p-1 border-b w-full"
                                       onblur="handleBudgetAmountEdit(${originalIndex}, this.value)"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '');" placeholder="0">
                                ${createCurrencySelectForBudget(originalIndex, currency)}
                            </div>
                        `;
                    } else if (field.key === 'mapLink') {
                        const url = item.mapLink || '';
                        const text = url ? 'ğŸ—ºï¸ æŸ¥çœ‹' : 'ğŸ“ è¨­å®š';
                        cell.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <a href="${url}" target="_blank" class="text-rose-500 hover:text-rose-700 text-sm ${url ? '' : 'text-gray-400 italic'}">${text}</a>
                                <button onclick="startMapLinkEdit(${originalIndex})" class="p-1 hover:bg-rose-100 rounded-full">âœï¸</button>
                            </div>
                        `;
                    } else if (field.key === 'notes') {
                        let content = item[field.key] || '';
                        cell.innerHTML = content;
                        if (field.editable) {
                            cell.contentEditable = true;
                            cell.onblur = (e) => handleCellEdit(originalIndex, field.key, e.target.innerHTML, false, true);
                        }
                    } else {
                        let content = item[field.key] || '';
                        cell.textContent = content;
                        if (field.editable) {
                            cell.contentEditable = true;
                            cell.onblur = (e) => handleCellEdit(originalIndex, field.key, e.target.innerText, false);
                        }
                    }
                });

                const delCell = row.insertCell();
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteRow(${originalIndex})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
        }

        function addRow() {
            let newDay = new Date().toISOString().substring(0, 10);
            let newTime = "09:00";
            if (currentFilterDay !== 'all' && currentFilterDay.match(/^\d{4}-\d{2}-\d{2}$/)) {
                newDay = currentFilterDay;
                const filteredItems = itineraryData.filter(item => item.day === newDay && item.time);
                if (filteredItems.length > 0) {
                    const maxTimeStr = filteredItems.reduce((max, item) => item.time > max ? item.time : max, "00:00");
                    const [h, m] = maxTimeStr.split(':').map(Number);
                    let tempDate = new Date();
                    tempDate.setFullYear(2000, 0, 1);
                    tempDate.setHours(h);
                    tempDate.setMinutes(m + 30);
                    const newH = String(tempDate.getHours()).padStart(2, '0');
                    const newM = String(tempDate.getMinutes()).padStart(2, '0');
                    newTime = `${newH}:${newM}`;
                }
            }

            itineraryData.push({
                day: newDay,
                time: newTime,
                location: "æ–°å¢åœ°é»",
                travelTime: "",
                mapLink: "",
                estimatedAmount: 0,
                budgetCurrency: 'JPY',
                notes: ""
            });
            saveData();
        }

        function createCurrencySelectForBudget(index, current) {
            return `
                <select onchange="handleBudgetCurrencyChange(${index}, this.value)" class="p-0 border-none rounded text-xs bg-gray-100 text-gray-700 w-full text-center">
                    <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
                    <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                </select>
            `;
        }

        function handleBudgetAmountEdit(index, value) {
            const parsed = parseInt(value.replace(/[^0-9]/g, '')) || 0;
            itineraryData[index].estimatedAmount = parsed;
            saveData();
        }

        function handleBudgetCurrencyChange(index, currency) {
            itineraryData[index].budgetCurrency = currency;
            saveData();
        }

        function handleCellEdit(index, key, value, isBudget, isHtmlContent = false) {
            let parsed = isHtmlContent ? (value === '<br>' || value === '<div><br></div>' || value.trim() === '' ? '' : value) : value.trim();
            itineraryData[index][key] = parsed;
            saveData();
        }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                itineraryData.splice(index, 1);
                saveData();
            }
        }

        function calculateTotals() {
            let totalJpyAll = 0, totalTwdAll = 0, totalJpyFiltered = 0, totalTwdFiltered = 0;
            const calculateTwdFromBudget = (amount, currency) => currency === 'JPY' ? Math.round((parseInt(amount) || 0) * EXCHANGE_RATE) : (parseInt(amount) || 0);
            const calculateJpyFromBudget = (amount, currency) => currency === 'TWD' ? Math.round((parseInt(amount) || 0) / EXCHANGE_RATE) : (parseInt(amount) || 0);

            itineraryData.forEach(item => {
                const amount = item.estimatedAmount || 0;
                const currency = item.budgetCurrency || 'JPY';
                totalTwdAll += calculateTwdFromBudget(amount, currency);
                totalJpyAll += calculateJpyFromBudget(amount, currency);
                if (currentFilterDay === 'all' || item.day === currentFilterDay) {
                    totalTwdFiltered += calculateTwdFromBudget(amount, currency);
                    totalJpyFiltered += calculateJpyFromBudget(amount, currency);
                }
            });

            document.getElementById('totalEstimatedJpy').textContent = `${totalJpyAll.toLocaleString()} JPY`;
            document.getElementById('totalEstimatedTwd').textContent = `${totalTwdAll.toLocaleString()} TWD`;
            document.getElementById('filteredTotalJpy').textContent = `${totalJpyFiltered.toLocaleString()} JPY`;
            document.getElementById('filteredTotalTwd').textContent = `${totalTwdFiltered.toLocaleString()} TWD`;
        }

        function startMapLinkEdit(index) {
            const row = document.querySelector(`#itineraryBody tr[data-original-index="${index}"]`);
            if (!row) return;
            const cell = row.cells[3];
            const input = document.createElement('input');
            input.type = 'url';
            input.value = itineraryData[index].mapLink || '';
            input.className = 'w-full p-1 border-2 border-rose-300 rounded';
            input.placeholder = 'è²¼ä¸ŠGoogleåœ°åœ–é€£çµ';
            input.onblur = () => {
                itineraryData[index].mapLink = input.value;
                saveData();
                renderTable();
            };
            input.onkeypress = (e) => e.key === 'Enter' && input.blur();
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        function showPage(pageName) {
            currentPage = pageName;
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-view').classList.toggle('hidden', pageName !== 'wishlist');
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-actions').classList.toggle('hidden', pageName !== 'wishlist');
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('wishlist-tab').className = pageName === 'wishlist' ? 'tab tab-active' : 'tab tab-inactive';
            if (pageName === 'split') renderSplitView();
            if (pageName === 'wishlist') renderWishlistTable();
            if (pageName === 'itinerary') renderDayFilter();
        }

        function updateExchangeRate(rate) {
            EXCHANGE_RATE = rate;
            document.getElementById('exchangeRate').value = rate.toFixed(2);
        }

        async function fetchExchangeRate() {
            alert("ç„¡æ³•è‡ªå‹•æ›´æ–°åŒ¯ç‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ï¼");
        }

        function renderWishlistTable() {
            const tbody = document.getElementById('wishlistBody');
            tbody.innerHTML = '';
            wishlistData.sort((a, b) => a.priority - b.priority || a.id - b.id);
            wishlistData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.id = `wish-${item.id}`;
                row.className = 'hover:bg-gray-50 transition duration-150';

                let cell = row.insertCell();
                cell.className = 'p-3 table-cell w-16';
                cell.innerHTML = createTypeSelect(item.id, item.type);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-40';
                cell.contentEditable = true;
                cell.textContent = item.name || 'æ–°æƒ³æ³•';
                cell.onblur = (e) => handleWishlistCellEdit(item.id, 'name', e.target.innerText);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-48';
                const url = item.link || '';
                const text = url ? 'ğŸ”— æ‰“é–‹é€£çµ' : 'ğŸ“ è¨­å®šé€£çµ';
                cell.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <a href="${url}" target="_blank" class="text-rose-500 hover:text-rose-700 text-sm ${url ? '' : 'text-gray-400 italic'}">${text}</a>
                        <button onclick="startWishlistLinkEdit('${item.id}', '${url}')" class="p-1 hover:bg-rose-100 rounded-full">âœï¸</button>
                    </div>
                `;

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-20 text-center';
                cell.innerHTML = createPrioritySelect(item.id, item.priority);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-32';
                cell.innerHTML = createSuggestedBySelect(item.id, item.suggestedBy);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-48';
                cell.contentEditable = true;
                cell.innerHTML = item.notes || '';
                cell.onblur = (e) => handleWishlistCellEdit(item.id, 'notes', e.target.innerHTML, true);

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-16 text-center';
                const voteCount = item.votes ? Object.keys(item.votes).length : 0;
                cell.innerHTML = `<button onclick="handleVote('${item.id}')" class="text-xl ${voteCount > 0 ? 'text-red-500' : 'text-gray-300'} hover:text-red-400 transition duration-150">â¤ï¸ (${voteCount})</button>`;

                cell = row.insertCell();
                cell.className = 'p-3 table-cell w-16 text-center';
                cell.innerHTML = `<button onclick="deleteWishlistItem('${item.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
        }

        function handleWishlistCellEdit(id, key, value, isHtmlContent = false) {
            const index = wishlistData.findIndex(item => item.id === id);
            if (index > -1) {
                let parsed = isHtmlContent ? (value === '<br>' || value === '<div><br></div>' || value.trim() === '' ? '' : value) : value.trim();
                wishlistData[index][key] = parsed;
                saveData();
                renderWishlistTable();
            }
        }

        function addWishlistItem() {
            const newId = Date.now().toString();
            wishlistData.push({
                id: newId,
                type: 'æ™¯é»',
                name: 'æ–°æƒ³æ³• (é»æ­¤ä¿®æ”¹)',
                link: '',
                priority: 3,
                suggestedBy: PEOPLE[0] || 'Aå›',
                notes: '',
                votes: {}
            });
            saveData();
        }

        function deleteWishlistItem(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¾…å®šæƒ³æ³•ï¼Ÿ')) {
                wishlistData = wishlistData.filter(item => item.id !== id);
                saveData();
            }
        }

        function handleVote(id) {
            const index = wishlistData.findIndex(item => item.id === id);
            if (index > -1) {
                const currentVoter = PEOPLE[0] || 'Aå›';
                if (!wishlistData[index].votes) wishlistData[index].votes = {};
                if (wishlistData[index].votes[currentVoter]) {
                    delete wishlistData[index].votes[currentVoter];
                } else {
                    wishlistData[index].votes[currentVoter] = true;
                }
                saveData();
            }
        }

        function startWishlistLinkEdit(id, currentLink) {
            const row = document.getElementById(`wish-${id}`);
            const cell = row.cells[2];
            const input = document.createElement('input');
            input.type = 'url';
            input.value = currentLink || '';
            input.className = 'w-full p-1 border-2 border-rose-300 rounded text-sm';
            input.placeholder = 'è²¼ä¸ŠGoogleåœ°åœ–æˆ–ç¶²ç«™é€£çµ';
            input.onblur = () => {
                const index = wishlistData.findIndex(item => item.id === id);
                if (index > -1) {
                    wishlistData[index].link = input.value;
                    saveData();
                    renderWishlistTable();
                }
            };
            input.onkeypress = (e) => e.key === 'Enter' && input.blur();
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        function createTypeSelect(id, current) {
            const types = ['æ™¯é»', 'ç¾é£Ÿ', 'è³¼ç‰©', 'äº¤é€š', 'ä½å®¿'];
            let options = types.map(type => `<option value="${type}" ${current === type ? 'selected' : ''}>${type}</option>`).join('');
            return `
                <select onchange="handleWishlistCellEdit('${id}', 'type', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        function createPrioritySelect(id, current) {
            const priorities = [
                { value: 1, label: 'â˜… å¿…å»' },
                { value: 2, label: 'â˜…â˜… å»ºè­°' },
                { value: 3, label: 'â˜…â˜…â˜… éš¨ç·£' }
            ];
            let options = priorities.map(p => `<option value="${p.value}" ${current == p.value ? 'selected' : ''}>${p.label}</option>`).join('');
            return `
                <select onchange="handleWishlistCellEdit('${id}', 'priority', parseInt(this.value))" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        function createSuggestedBySelect(id, current) {
            let options = PEOPLE.map(person => `<option value="${person}" ${current === person ? 'selected' : ''}>${person}</option>`).join('');
            return `
                <select onchange="handleWishlistCellEdit('${id}', 'suggestedBy', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        function togglePersonEditModal() {
            const newNames = prompt("ç·¨è¼¯åƒèˆ‡äººåå–® (è«‹ç”¨é€—è™Ÿåˆ†éš”)", PEOPLE.join(','));
            if (newNames !== null) {
                const newPeopleArray = newNames.split(',').map(name => name.trim()).filter(name => name);
                if (newPeopleArray.length > 0) {
                    PEOPLE = newPeopleArray;
                    saveData();
                    if (currentPage === 'split') renderSplitView();
                    alert("äººåå·²æ›´æ–°ï¼è«‹æª¢æŸ¥åˆ†å¸³çµæœæ˜¯å¦æ­£ç¢ºã€‚");
                } else {
                    alert("äººåä¸èƒ½ç‚ºç©ºã€‚");
                }
            }
        }

        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
        };
    </script>
</body>
</html>

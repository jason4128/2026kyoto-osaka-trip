<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½å¤§é˜ªæ—…éŠè¡Œç¨‹åŠåˆ†å¸³ç³»çµ± v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        [contenteditable]:focus {
            outline: 2px solid #3b82f6;
            background-color: #eef2ff;
        }
        .table-cell { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; }
        .header-cell {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white; position: sticky; top: 0; z-index: 10;
        }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { background-color: white; color: #1d4ed8; border-top: 3px solid #1d4ed8; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-bottom: 1px solid white; }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; }
        .currency-input-container {
            display: flex; justify-content: flex-end; align-items: center; padding: 4px 8px; 
            border: 1px solid #d1d5db; border-radius: 6px; background-color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .currency-input-container:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.5); }
        .currency-input { appearance: none; width: 8rem; text-align: right; padding: 0; border: none; outline: none; background: transparent; }
        .currency-input::-webkit-outer-spin-button, .currency-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .dragging { opacity: 0.7; transform: rotate(2deg); border: 2px dashed #3b82f6; }
        .drag-over { border-top: 2px solid #10b981; background-color: #f0fdf4 !important; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 50;
        }
        .modal-content {
            background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto;
        }
        @media (max-width: 768px) {
            .currency-input { width: 5rem !important; font-size: 14px; }
            .table-cell { padding: 8px 4px !important; font-size: 12px; }
            .tab { padding: 8px 12px !important; font-size: 14px; }
            .modal-content { margin: 20% auto; }
        }
        .smooth-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="p-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-xl">
            <h1 class="text-3xl font-bold text-white mb-2">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ª4å¤©3å¤œæ—…éŠè¦åŠƒ v2.1 ğŸ¯</h1>
            <p class="text-blue-100 text-sm">âœ¨ æ‹–æ›³æ•´åˆ—èª¿æ•´é †åº | âœï¸é»æ“Šç·¨è¼¯åœ°åœ– | å³æ™‚åˆ†å¸³è¨ˆç®—</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">ğŸ“… è¡Œç¨‹è¡¨</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">ğŸ’° åˆ†å¸³è¡¨ (6äºº)</div>
        </div>

        <!-- Configuration Bar -->
        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY åŒ¯ç‡:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView()"
                           title="å³æ™‚åŒ¯ç‡ (ä¾‹å¦‚: 22.50)">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ğŸ”„ æ›´æ–°</button>
            </div>
            <div id="itinerary-actions" class="">
                <button onclick="addRow()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ æ–°å¢è¡Œç¨‹</button>
                <button onclick="loadDefaultItinerary()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow ml-2 text-sm">ğŸ“‹ è¼‰å…¥é è¨­</button>
            </div>
            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ ç™»è¼‰æ”¯å‡º</button>
                <button onclick="togglePersonEditModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">ğŸ‘¤ ç·¨è¼¯äººå</button>
            </div>
        </div>

        <!-- Itinerary View -->
        <div id="itinerary-view" class="p-4 sm:p-6">
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-16">æ—¥æœŸ</th>
                            <th class="header-cell w-20">æ™‚é–“</th>
                            <th class="header-cell w-48">åœ°é»</th>
                            <th class="header-cell w-16 rounded-tr-xl">è©³ç´°</th>
                            <th class="header-cell w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- è¡Œç¨‹æ•¸æ“šç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gradient-to-r from-blue-50 to-purple-50 text-base font-bold text-gray-800">
                            <td colspan="3" class="table-cell text-right py-4">ç¸½è¨ˆ:</td>
                            <td id="totalSpentJpy" class="table-cell text-right py-4 text-red-600" colspan="2">0 JPY</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Split View -->
        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’µ æ”¯å‡ºç™»è¼‰è¡¨</h2>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">é …ç›®åç¨±</th>
                            <th class="p-3 w-40 text-right">é‡‘é¡</th>
                            <th class="p-3 w-28">å¹£åˆ¥</th>
                            <th class="p-3 w-32">ä»˜æ¬¾äºº</th>
                            <th class="p-3 w-40 text-right">å°å¹£é‡‘é¡</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- æ”¯å‡ºæ•¸æ“šç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">âš–ï¸ å³æ™‚çµç®—çµæœ</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ”„ è½‰å¸³æ¸…å–® (èª°è©²ä»˜èª°)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-yellow-50 text-gray-800"></div>
        </div>

        <!-- Modal for Details -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">è¡Œç¨‹è©³ç´°è³‡è¨Š</h3>
                <div id="modalContent" class="space-y-2"></div>
                <button onclick="closeModal()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        const JPY_TO_TWD_RATE_KEY = 'jpyToTwdRate';
        const ITINERARY_KEY = 'itineraryData';
        const EXPENSES_KEY = 'splitExpenses';
        const PEOPLE_KEY = 'splitPeople';
        
        let EXCHANGE_RATE = parseFloat(localStorage.getItem(JPY_TO_TWD_RATE_KEY)) || 22.50;
        const DEFAULT_PEOPLE = ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'];
        let PEOPLE = JSON.parse(localStorage.getItem(PEOPLE_KEY)) || DEFAULT_PEOPLE;
        
        // ğŸš€ æ ¹æ“šæ‚¨æä¾›çš„è¡Œç¨‹æ›´æ–°é è¨­è¡Œç¨‹
        const DEFAULT_ITINERARY = [
            { day: 1, time: "10:40", location: "é—œè¥¿æ©Ÿå ´ (KIX)", travelTime: "-", mapLink: "https://maps.app.goo.gl/xtkMSFk3du8WPVm56", spentJpy: 0, estimatedJpy: 0, notes: "æŠµé”ï¼Œåœ‹éš›èˆªç­" },
            { day: 1, time: "11:15", location: "Haruka ç‰¹æ€¥åˆ—è»Š", travelTime: "75åˆ†é˜", mapLink: "", spentJpy: 0, estimatedJpy: 3000, notes: "å‰å¾€äº¬éƒ½ï¼Œé ä¼°è²»ç”¨/äººï¼Œ11:30ç­" },
            { day: 1, time: "12:45", location: "äº¬éƒ½è»Šç«™", travelTime: "-", mapLink: "https://maps.app.goo.gl/WCbZVcRP3QuDkZrx6", spentJpy: 0, estimatedJpy: 0, notes: "ä¸‹è»Šï¼Œæº–å‚™å‰å¾€ teamLab" },
            { day: 1, time: "13:00", location: "teamLab äº¬éƒ½", travelTime: "æ­¥è¡Œ10-15åˆ†é˜", mapLink: "https://maps.app.goo.gl/BwFDkKYabevQ8f2ZA", spentJpy: 0, estimatedJpy: 1500, notes: "çœ‹å±•ï¼Œé ä¼°é–€ç¥¨/äºº" },
            { day: 1, time: "15:00", location: "ç¥‡åœ’ä¸¸å¤ªç”ºä½å®¿", travelTime: "åœ°éµ/å·´å£«15-20åˆ†", mapLink: "https://maps.app.goo.gl/DeLeDL48Ep9YCfZL8", spentJpy: 0, estimatedJpy: 0, notes: "æŠµé”å¯„æ”¾è¡Œæï¼Œ15:00å…¥ä½ï¼Œ5æ™š" },
            { day: 5, time: "11:00", location: "ç¥‡åœ’ä¸¸å¤ªç”ºä½å®¿", travelTime: "-", mapLink: "https://maps.app.goo.gl/DeLeDL48Ep9YCfZL8", spentJpy: 0, estimatedJpy: 0, notes: "é€€æˆ¿" },
            { day: 5, time: "14:00", location: "é¶´INN é‡Œä»å±…", travelTime: "åœ°éµ/å·´å£«ç´„1å°æ™‚", mapLink: "https://maps.app.goo.gl/3ubHUkZm48rxG9WV7", spentJpy: 0, estimatedJpy: 0, notes: "æŠµé”ï¼Œ16:00å…¥ä½ï¼Œ3æ™š" },
            { day: 8, time: "09:00", location: "é¶´INN é‡Œä»å±…", travelTime: "-", mapLink: "https://maps.app.goo.gl/3ubHUkZm48rxG9WV7", spentJpy: 0, estimatedJpy: 0, notes: "é€€æˆ¿æº–å‚™ï¼Œå›ç¨‹" },
            { day: 8, time: "09:30", location: "Haruka ç‰¹æ€¥åˆ—è»Š", travelTime: "75åˆ†é˜", mapLink: "", spentJpy: 0, estimatedJpy: 3000, notes: "å›é—œè¥¿æ©Ÿå ´ï¼Œé ä¼°è²»ç”¨/äºº" },
            { day: 8, time: "10:45", location: "é—œè¥¿æ©Ÿå ´ (KIX)", travelTime: "-", mapLink: "https://maps.app.goo.gl/xtkMSFk3du8WPVm56", spentJpy: 0, estimatedJpy: 0, notes: "æŠµé”æ©Ÿå ´ï¼Œ11:30èˆªç­" }
        ];
        
        let itineraryData = JSON.parse(localStorage.getItem(ITINERARY_KEY)) || DEFAULT_ITINERARY;
        let expenses = JSON.parse(localStorage.getItem(EXPENSES_KEY)) || [
            { id: Date.now() - 1, description: "ä¾†å›æ©Ÿç¥¨", amount: 33500, currency: "TWD", payer: 'Aå›' },
            { id: Date.now(), description: "Day1æ™šé¤", amount: 8400, currency: "JPY", payer: 'Cå›' }
        ];
        let currentPage = 'itinerary';

        // === æ ¸å¿ƒåŠŸèƒ½ ===
        function updateExchangeRate(rate) {
            EXCHANGE_RATE = rate;
            localStorage.setItem(JPY_TO_TWD_RATE_KEY, rate.toFixed(2));
            document.getElementById('exchangeRate').value = rate.toFixed(2);
        }

        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await response.json();
                const rate = data.rates.TWD;
                updateExchangeRate(rate);
                calculateTotals();
                renderSplitView();
            } catch (e) {
                // å®‰éœå¤±æ•—
            }
        }

        function showPage(pageName) {
            currentPage = pageName;
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            if (pageName === 'split') renderSplitView();
        }

        // === è¡Œç¨‹è¡¨åŠŸèƒ½ ===
        function renderTable() {
            const tbody = document.getElementById('itineraryBody');
            tbody.innerHTML = '';
            
            itineraryData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 smooth-transition cursor-move';
                row.dataset.index = index;
                row.draggable = true;
                row.addEventListener('dragstart', (e) => handleDragStart(e, index));
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', (e) => handleDrop(e, index));
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('touchstart', (e) => handleTouchStart(e, index), { passive: true });
                row.addEventListener('touchmove', handleTouchMove);
                row.addEventListener('touchend', handleTouchEnd);

                const cells = [
                    { key: 'day', editable: true, class: 'font-bold' },
                    { key: 'time', editable: true },
                    { key: 'location', editable: true }
                ];

                cells.forEach(field => {
                    const cell = document.createElement('td');
                    cell.className = `table-cell ${field.class || ''}`;
                    let content = item[field.key] || '';
                    cell.textContent = content;
                    if (field.editable) {
                        cell.contentEditable = true;
                        cell.onblur = (e) => handleCellEdit(index, field.key, e.target.innerText);
                    }
                    row.appendChild(cell);
                });

                const detailCell = document.createElement('td');
                detailCell.className = 'table-cell text-center';
                detailCell.innerHTML = `<button onclick="showDetail(${index})" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50">ğŸ“–</button>`;
                row.appendChild(detailCell);

                const delCell = document.createElement('td');
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteRow(${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
                row.appendChild(delCell);

                tbody.appendChild(row);
            });
            calculateTotals();
        }

        function handleCellEdit(index, key, value) {
            let parsed = value.trim();
            itineraryData[index][key] = parsed;
            saveItinerary();
            renderTable();
        }

        function showDetail(index) {
            const item = itineraryData[index];
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <p><strong>äº¤é€š:</strong> ${item.travelTime || '-'}</p>
                <p><strong>åœ°åœ–:</strong> ${item.mapLink ? `<a href="${item.mapLink}" target="_blank" class="text-blue-500 hover:text-blue-700">æŸ¥çœ‹åœ°åœ–</a>` : '-'}</p>
                <p><strong>å·²æ”¯å‡º (JPY):</strong> ${item.spentJpy.toLocaleString() || '0'}</p>
                <p><strong>é ç®— (JPY):</strong> ${item.estimatedJpy.toLocaleString() || '0'}</p>
                <p><strong>å°å¹£ (TWD):</strong> ${Math.round(item.spentJpy * EXCHANGE_RATE).toLocaleString() || '0'}</p>
                <p><strong>å‚™è¨»:</strong> ${item.notes || '-'}</p>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        let draggedIndex = null;
        let touchStartIndex = null;
        let touchStartY = 0;

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) { e.preventDefault(); }

        function handleDragEnter(e) { e.target.closest('tr')?.classList.add('drag-over'); }

        function handleDragLeave(e) { e.target.closest('tr')?.classList.remove('drag-over'); }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('dragging', 'drag-over'));
            if (draggedIndex !== targetIndex) {
                const [item] = itineraryData.splice(draggedIndex, 1);
                itineraryData.splice(targetIndex, 0, item);
                saveItinerary();
                renderTable();
            }
        }

        // è§¸æ§äº‹ä»¶è™•ç†
        function handleTouchStart(e, index) {
            touchStartIndex = index;
            touchStartY = e.touches[0].clientY;
            e.target.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (touchStartIndex === null) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - touchStartY;
            const rows = Array.from(document.querySelectorAll('#itineraryBody tr'));
            const currentRow = rows[touchStartIndex];
            const rect = currentRow.getBoundingClientRect();
            const scrollThreshold = 50;

            if (deltaY > 0) {
                const nextRow = rows[touchStartIndex + 1];
                if (nextRow && touchY > rect.bottom + scrollThreshold) {
                    handleTouchDrop(touchStartIndex, touchStartIndex + 1);
                }
            } else if (deltaY < 0) {
                const prevRow = rows[touchStartIndex - 1];
                if (prevRow && touchY < rect.top - scrollThreshold) {
                    handleTouchDrop(touchStartIndex, touchStartIndex - 1);
                }
            }
        }

        function handleTouchEnd() {
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('dragging', 'drag-over'));
            touchStartIndex = null;
            touchStartY = 0;
        }

        function handleTouchDrop(fromIndex, toIndex) {
            if (fromIndex !== toIndex) {
                const [item] = itineraryData.splice(fromIndex, 1);
                itineraryData.splice(toIndex, 0, item);
                saveItinerary();
                renderTable();
            }
        }

        function addRow() {
            const lastDay = itineraryData.length ? Math.max(...itineraryData.map(i => i.day)) : 1;
            itineraryData.push({
                day: lastDay, time: "00:00", location: "æ–°å¢åœ°é»", travelTime: "", mapLink: "", spentJpy: 0, estimatedJpy: 0, notes: ""
            });
            saveItinerary();
            renderTable();
        }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                itineraryData.splice(index, 1);
                saveItinerary();
                renderTable();
            }
        }

        function loadDefaultItinerary() {
            if (confirm('è¼‰å…¥é è¨­4å¤©3å¤œè¡Œç¨‹ï¼Œå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Ÿ')) {
                itineraryData = [...DEFAULT_ITINERARY];
                saveItinerary();
                renderTable();
            }
        }

        function calculateTotals() {
            const totalSpent = itineraryData.reduce((sum, i) => sum + (i.spentJpy || 0), 0);
            document.getElementById('totalSpentJpy').textContent = `${totalSpent.toLocaleString()} JPY`;
        }

        function saveItinerary() { localStorage.setItem(ITINERARY_KEY, JSON.stringify(itineraryData)); }

        // ğŸ”¥ === åˆ†å¸³åŠŸèƒ½ ===
        let updateTimeout = null;

        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
                const row = tbody.insertRow();
                row.id = `expense-${expense.id}`;
                
                const descCell = row.insertCell();
                descCell.className = 'table-cell';
                descCell.innerHTML = `<span contenteditable="true" onblur="updateExpenseField(${expense.id}, 'description', this.textContent)">${expense.description}</span>`;
                
                const amountCell = row.insertCell();
                amountCell.className = 'table-cell text-right p-2';
                amountCell.innerHTML = `
                    <div class="currency-input-container">
                        <input type="number" 
                               value="${expense.amount}" 
                               min="0" 
                               class="currency-input"
                               oninput="handleAmountInput(${expense.id}, this.value)"
                               onblur="finalizeAmountUpdate(${expense.id}, this.value)"
                               placeholder="0">
                    </div>
                `;
                
                const currencyCell = row.insertCell();
                currencyCell.className = 'table-cell';
                currencyCell.innerHTML = createCurrencySelect(expense.id, expense.currency);
                
                const payerCell = row.insertCell();
                payerCell.className = 'table-cell';
                payerCell.innerHTML = createPayerSelect(expense.id, expense.payer);
                
                const twdCell = row.insertCell();
                twdCell.className = 'table-cell text-right font-mono text-green-600';
                twdCell.id = `twd-${expense.id}`;
                twdCell.textContent = `${calculateTwdEquivalent(expense.amount, expense.currency).toLocaleString()} TWD`;
                
                const delCell = row.insertCell();
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteExpense(${expense.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
            
            setTimeout(() => calculateAndRenderSettlement(), 100);
        }

        function handleAmountInput(id, value) {
            clearTimeout(updateTimeout);
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.amount = parseFloat(value) || 0;
                const twdCell = document.getElementById(`twd-${id}`);
                if (twdCell) {
                    twdCell.textContent = `${calculateTwdEquivalent(value, expense.currency).toLocaleString()} TWD`;
                }
            }
        }

        function finalizeAmountUpdate(id, value) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.amount = parseFloat(value) || 0;
                localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses));
                setTimeout(() => calculateAndRenderSettlement(), 200);
            }
        }

        function createCurrencySelect(id, current) {
            return `<select onchange="updateExpenseField(${id}, 'currency', this.value)" class="p-1 border rounded w-full">
                <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
            </select>`;
        }

        function createPayerSelect(id, current) {
            return `<select onchange="updateExpenseField(${id}, 'payer', this.value)" class="p-1 border rounded w-full">
                ${PEOPLE.map(p => `<option value="${p}" ${current === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>`;
        }

        function updateExpenseField(id, field, value) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense[field] = value;
                localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses));
                
                if (field === 'currency' || field === 'amount') {
                    const twdCell = document.getElementById(`twd-${id}`);
                    if (twdCell) {
                        twdCell.textContent = `${calculateTwdEquivalent(expense.amount, expense.currency).toLocaleString()} TWD`;
                    }
                }
                
                setTimeout(() => calculateAndRenderSettlement(), 200);
            }
        }

        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num * EXCHANGE_RATE) : Math.round(num);
        }

        function addExpense() {
            expenses.push({
                id: Date.now(), description: 'æ–°æ”¯å‡º', amount: 0, currency: 'JPY', payer: PEOPLE[0]
            });
            localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses));
            renderSplitView();
        }

        function deleteExpense(id) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses));
                renderSplitView();
            }
        }

        function togglePersonEditModal() {
            const names = prompt('è¼¸å…¥6äººå§“å (é€—è™Ÿåˆ†éš”):', PEOPLE.join(','));
            if (names) {
                const newPeople = names.split(',').map(n => n.trim()).filter(Boolean);
                if (newPeople.length === 6) {
                    PEOPLE = newPeople;
                    localStorage.setItem(PEOPLE_KEY, JSON.stringify(PEOPLE));
                    renderSplitView();
                } else alert('è«‹è¼¸å…¥æ­£å¥½6å€‹å§“åï¼');
            }
        }

        function calculateAndRenderSettlement() {
            const balance = {};
            PEOPLE.forEach(p => balance[p] = 0);
            let totalTWD = 0;
            
            expenses.forEach(e => {
                const twd = calculateTwdEquivalent(e.amount, e.currency);
                balance[e.payer] += twd;
                totalTWD += twd;
            });
            
            const sharePerPerson = totalTWD / PEOPLE.length;
            
            const netBalance = {};
            PEOPLE.forEach(person => {
                netBalance[person] = Math.round((balance[person] - sharePerPerson) * 100) / 100; 
            });
            
            const creditors = []; 
            const debtors = [];   
            
            PEOPLE.forEach(person => {
                const amount = Math.abs(Math.round(netBalance[person]));
                if (netBalance[person] > 0) {
                    creditors.push({ name: person, amount });
                } else if (netBalance[person] < 0 && amount > 0) {
                    debtors.push({ name: person, amount });
                }
            });
            
            let settlements = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const transfer = Math.min(debtors[i].amount, creditors[j].amount);
                if (transfer >= 1) {
                    settlements.push({
                        from: debtors[i].name,
                        to: creditors[j].name,
                        amount: transfer
                    });
                }
                debtors[i].amount -= transfer;
                creditors[j].amount -= transfer;
                
                if (debtors[i].amount < 1) i++;
                if (creditors[j].amount < 1) j++;
            }
            
            renderSettlementSummary(totalTWD, sharePerPerson, netBalance);
            renderSettlementList(settlements);
        }

        function renderSettlementSummary(totalTWD, sharePerPerson, netBalance) {
            document.getElementById('settlement-summary').innerHTML = `
                <div class="p-4 bg-blue-100 rounded-lg">
                    <p class="text-sm">ç¸½æ”¯å‡º</p>
                    <p class="text-2xl font-bold text-blue-900">${totalTWD.toLocaleString()} TWD</p>
                </div>
                <div class="p-4 bg-green-100 rounded-lg">
                    <p class="text-sm">æ¯äººæ‡‰ä»˜</p>
                    <p class="text-2xl font-bold text-green-900">${Math.round(sharePerPerson).toLocaleString()} TWD</p>
                </div>
                <div class="p-4 bg-purple-100 rounded-lg">
                    <p class="text-sm font-medium">å€‹äººçµé¤˜</p>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                        ${PEOPLE.map(person => {
                            const net = Math.round(netBalance[person]);
                            const color = net >= 0 ? 'text-green-700' : 'text-red-700';
                            const bg = net >= 0 ? 'bg-green-50' : 'bg-red-50';
                            return `<div class="p-1 rounded text-center ${bg}">
                                <strong>${person}</strong><br>
                                <span class="${color} font-bold">${net >= 0 ? '+' : ''}${net}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderSettlementList(settlements) {
            const listDiv = document.getElementById('settlement-list');
            
            if (settlements.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-green-600 font-bold py-4">âœ… å¸³ç›®å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</p>';
                listDiv.className = 'space-y-3 p-4 border rounded-lg bg-green-50 text-gray-800';
            } else {
                listDiv.innerHTML = settlements.map(s => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-md shadow border border-yellow-200">
                        <span class="font-medium">${s.from}</span>
                        <span class="text-gray-500 mx-2">â¡ï¸ è½‰</span>
                        <span class="font-medium">${s.to}</span>
                        <span class="ml-auto font-bold text-lg text-red-600">${s.amount.toLocaleString()} TWD</span>
                    </div>
                `).join('');
                listDiv.className = 'space-y-3 p-4 border rounded-lg bg-yellow-50 text-gray-800';
            }
        }

        // === åˆå§‹åŒ– ===
        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
            renderTable();
        };
    </script>
</body>
</html>

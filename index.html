<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🇯🇵 京都大阪旅遊規劃 🏯 - 禪意協作版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- === Firebase V9 MODULAR SDK 引入 (使用 module 類型腳本) === -->
    <script type="module">
        // 模組化引入所需的函數
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        // === 您的 Firebase 配置 (已替換為您提供的真實配置) ===
        // 注意：這裡使用硬編碼的 API Key/URL 是因為 Canvas 環境的限制，實際專案應妥善保護
        const firebaseConfig = {
            apiKey: "AIzaSyCOxm1LPBq5L9JdZH4gaS1b4DYGc6CME_o",
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.firebasestorage.app",
            messagingSenderId: "473684537567",
            appId: "1:473684537567:web:52b103a59e678bd478b96a",
            measurementId: "G-BETXRCZPMH"
        };
        
        // 初始化 Firebase App
        const app = initializeApp(firebaseConfig);
        // 取得 Realtime Database 實例
        window.db = getDatabase(app); 
        
        // 將核心函數暴露到全局 window，供下方非 module 腳本使用
        window.ref = ref;
        window.onValue = onValue;
        window.set = set;
        window.firebaseConfig = firebaseConfig; // 暴露配置用於日誌記錄
        
        // 呼叫主邏輯函數
        window.startAppLogic();
    </script>

    <!-- Flatpickr 引入 (日曆/時間選擇器) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    
    <style>
        /* 🎨 基礎樣式和響應式調整 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #fffbeb; /* bg-amber-50 極淺米黃 */
            color: #333;
        }
        [contenteditable]:focus {
            outline: 2px solid #f472b6; /* 柔和玫瑰粉 */
            background-color: #fff7fa; /* 淺粉色背景 */
        }
        
        .table-cell { 
            padding: 12px; 
            border-bottom: 1px solid #e5e7eb; 
            vertical-align: top; 
            min-height: 48px; 
            line-height: 1.5;
        }
        
        .header-cell {
            background: linear-gradient(135deg, #fbcfe8, #f472b6); 
            color: #444; 
            position: sticky; top: 0; z-index: 10;
            padding: 12px;
        }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { 
            background-color: white; 
            color: #be185d; 
            border-top: 3px solid #be185d; 
            border-left: 1px solid #e5e7eb; 
            border-right: 1px solid #e5e7eb; 
            border-bottom: 1px solid white; 
        }
        .tab-inactive { background-color: #f3f4f6; color: #78716c; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; } 
        
        /* Flatpickr 樣式調整 - 確保 altInput 顯示正常 */
        .flatpickr-input[data-input] {
            opacity: 0;
            position: absolute;
            pointer-events: none;
            z-index: -1; 
        }
        
        .flatpickr-input {
            border: none !important;
            padding: 0 !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
            cursor: pointer;
            width: 100%;
        }
        
        .date-time-container {
            position: relative;
        }
        
        /* 響應式調整 */
        .w-16 { min-width: 64px; }
        .w-20 { min-width: 80px; }
        .w-32 { min-width: 128px; }
        .w-48 { min-width: 192px; }
        .w-28 { min-width: 112px; }
        .w-12 { min-width: 48px; }

        @media (max-width: 768px) {
            .table-cell { padding: 8px 4px !important; font-size: 12px; }
            .header-cell { font-size: 12px; padding: 8px 4px; }
            .overflow-x-auto { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 640px) {
            .table-cell { padding: 6px 2px !important; font-size: 11px !important; min-width: 60px !important; }
            #itineraryTable th, #expensesTable th { font-size: 10px !important; padding: 8px 2px !important; }
            .header-cell { padding: 6px 2px !important; font-size: 9px !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <header class="p-6 bg-gradient-to-r from-pink-100 to-yellow-50 rounded-t-xl border-b border-rose-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🇯🇵 京都大阪4天3夜旅遊規劃 🏯</h1>
            <p class="text-rose-600 text-sm">✨ 自動排序行程 | 📅 日曆式日期選擇 | 即時分帳計算</p>
            <div class="flex items-center justify-between mt-2">
                <span id="syncStatus" class="sync-status text-green-600 text-xs font-semibold">🔴 正在連接...</span>
                <span class="text-xs text-rose-500">最後更新: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <!-- 導覽列 -->
        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">📅 行程表</div>
            <div id="wishlist-tab" class="tab tab-inactive ml-2" onclick="showPage('wishlist')">💡 待定清單</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">💰 分帳表 (6人)</div>
        </div>

        <!-- 匯率與主要操作區 -->
        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY 匯率:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView(); saveData()"
                           title="即時匯率 (例如: 22.50)">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-rose-300 text-gray-800 px-3 py-1 rounded text-sm hover:bg-rose-400 transition duration-200">🔄 更新</button>
            </div>
            
            <div id="itinerary-actions" class="">
                <button onclick="addRow(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ 新增行程</button>
            </div>
            
            <div id="wishlist-actions" class="hidden">
                <button onclick="addWishlistItem(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ 新增想法</button>
            </div>
            
            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ 登載支出</button>
                <button onclick="togglePersonEditModal()" class="bg-rose-300 hover:bg-rose-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow text-sm">👤 編輯人名</button>
            </div>
        </div>

        <!-- 行程表視圖 -->
        <div id="itinerary-view" class="p-4 sm:p-6">
            <!-- 日期篩選器 & 總計 -->
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center space-x-2">
                    <label for="dayFilter" class="text-sm font-medium text-gray-700">顯示日期:</label>
                    <select id="dayFilter" onchange="filterItinerary(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm w-48 bg-white">
                        <option value="all">所有日期</option>
                        <!-- 選項將由 JS 填充 -->
                    </select>
                </div>
                <!-- 整體總預算 -->
                <div class="flex gap-4 text-sm font-bold text-gray-800">
                    <div class="bg-pink-100 p-2 rounded-md">總計 (JPY): <span id="totalEstimatedJpy" class="text-red-600">0 JPY</span></div>
                    <div class="bg-pink-100 p-2 rounded-md">總計 (TWD): <span id="totalEstimatedTwd" class="text-red-800">0 TWD</span></div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-28">日期/時間</th> 
                            <th class="header-cell w-48">地點</th>
                            <th class="header-cell w-32">交通</th>
                            <th class="header-cell w-28">地圖</th>
                            <th class="header-cell w-32 text-right">💰 預算</th> 
                            <th class="header-cell w-48 rounded-tr-xl">備註</th>
                            <th class="header-cell w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    <tfoot>
                        <!-- 篩選後總計欄位 -->
                        <tr class="bg-gradient-to-r from-pink-50 to-amber-50 text-base font-bold text-gray-800">
                            <td colspan="4" class="table-cell text-right py-4">所選日期總計:</td> 
                            <td class="table-cell py-4 text-sm">
                                <div class="text-red-600 mb-1" id="filteredTotalJpy">0 JPY</div>
                                <div class="text-red-800" id="filteredTotalTwd">0 TWD</div>
                            </td>
                            <td colspan="2" class="table-cell py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- 待定清單視圖 (略) -->
        <div id="wishlist-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">💡 待定景點/美食/購物清單</h2>
            <p class="text-sm text-gray-600 mb-4">點擊「愛心」投票表示對該項目有興趣！</p>
            <div class="overflow-x-auto shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-16">類別</th>
                            <th class="p-3 w-40">名稱</th>
                            <th class="p-3 w-48">地點/連結</th>
                            <th class="p-3 w-20 text-center">優先級</th>
                            <th class="p-3 w-32">提議人</th>
                            <th class="p-3 w-48">備註</th>
                            <th class="p-3 w-16 text-center">❤️ 投票</th>
                            <th class="p-3 w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- 分帳表視圖 (已實作邏輯) -->
        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">💵 支出登載表</h2>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table id="expensesTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">項目名稱</th>
                            <th class="p-3 w-24 text-right">金額</th>
                            <th class="p-3 w-16">幣別</th>
                            <th class="p-3 w-28">付款人</th>
                            <th class="p-3 w-12 text-center">分攤</th>
                            <th class="p-3 w-40 text-right">台幣金額</th>
                            <th class="p-3 w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">⚖️ 即時結算結果</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">🔄 轉帳清單 (誰該付誰)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-pink-50 text-gray-800"></div>
        </div>
    </div>
    
    <!-- 編輯人名 Modal (新增) -->
    <div id="personEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 class="text-xl font-bold mb-4">編輯團員名稱</h3>
            <textarea id="peopleInput" class="w-full p-2 border rounded resize-none" rows="6" placeholder="每行輸入一個名字，例如：&#10;A君&#10;B君&#10;..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="togglePersonEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button onclick="savePeopleNames()" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- 分攤人 Modal (新增) -->
    <div id="sharedByModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 class="text-xl font-bold mb-4">選擇分攤人</h3>
            <div id="sharedByCheckboxes" class="space-y-2">
                <!-- Checkboxes will be rendered here -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeSharedByModal()" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>


    <script>
        // === 全域變數 ===
        let EXCHANGE_RATE = 22.50;
        const DEFAULT_PEOPLE = ['A君', 'B君', 'C君', 'D君', 'E君', 'F君'];
        let PEOPLE = DEFAULT_PEOPLE;
        
        let itineraryData = [];
        let expenses = []; // 登載支出陣列
        let wishlistData = [];
        let currentPage = 'itinerary';
        let currentFilterDay = 'all'; 

        // Firebase V9 模組化語法的全局變數（由 module 腳本設定）
        let db; 
        let ref;
        let onValue;
        let set;
        
        // 追蹤目前正在編輯分攤人的支出ID
        let currentExpenseIdForSharedBy = null;


        // === 預設行程範本 (用於手動恢復) ===
        const DEFAULT_ITINERARY = [
            { day: "2026-03-20", time: "08:00", location: "抵達關西機場 (KIX)", travelTime: "機場快線", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "在機場購買 ICOCA/HARUKA" },
            { day: "2026-03-20", time: "11:00", location: "京都：飯店 Check-in", travelTime: "電車/地鐵", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "先寄放行李，下午開始行程" },
            { day: "2026-03-20", time: "14:00", location: "清水寺", travelTime: "公車", mapLink: "", estimatedAmount: 400, budgetCurrency: 'JPY', notes: "門票" },
            { day: "2026-03-21", time: "09:30", location: "嵐山：竹林小徑", travelTime: "JR/嵐電", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "早點去避開人潮" },
            { day: "2026-03-21", time: "12:30", location: "嵐山：午餐 (湯豆腐)", travelTime: "步行", mapLink: "", estimatedAmount: 3000, budgetCurrency: 'JPY', notes: "預計高價位午餐" },
            { day: "2026-03-22", time: "10:00", location: "大阪城", travelTime: "JR", mapLink: "", estimatedAmount: 600, budgetCurrency: 'JPY', notes: "天守閣門票" },
        ];


        // 啟動應用程序邏輯的函數
        window.startAppLogic = function() {
            // 從 window 取得 module 腳本設置的 Firebase 變數
            db = window.db; 
            ref = window.ref;
            onValue = window.onValue;
            set = window.set;
            
            console.log("Firebase App 已初始化，Database URL:", window.firebaseConfig.databaseURL);
            
            // 開始監聽資料庫
            startDataListener();

            // 暴露手動恢復功能到控制台
            window.restoreDefaultData = restoreDefaultData;
        }

        /**
         * 🚨 手動恢復功能：在控制台輸入 window.restoreDefaultData() 即可執行
         */
        function restoreDefaultData() {
            if (!confirm('🚨 警告：確定要覆蓋資料庫現有內容，並寫入預設的京阪行程範本嗎？')) {
                return;
            }
            console.warn("正在將預設資料寫入 Firebase Realtime Database...");

            set(ref(db, '/'), {
                itinerary: DEFAULT_ITINERARY,
                expenses: [],
                wishlist: [],
                people: DEFAULT_PEOPLE,
                rate: 22.50
            }).then(() => {
                alert("✅ 預設資料寫入成功！請重新整理頁面。");
                console.log("✅ 預設資料寫入成功，數據已同步。");
            }).catch((error) => {
                alert("❌ 寫入失敗，請檢查控制台。");
                console.error("Firebase 寫入失敗:", error);
            });
        }


        // === Realtime Database 監聽 (V9 語法) ===
        function startDataListener() {
            onValue(ref(db, '/'), (snapshot) => {
                const data = snapshot.val() || {};
                
                // console.log("從 Firebase 讀取資料:", data);
                
                // === 資料處理與初始化 ===
                itineraryData = data.itinerary || [];
                expenses = data.expenses || [];
                wishlistData = data.wishlist || []; 
                PEOPLE = data.people || DEFAULT_PEOPLE;
                EXCHANGE_RATE = data.rate || 22.50;
                
                document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
                
                // 根據當前分頁渲染
                if (currentPage === 'itinerary') {
                    renderDayFilter();
                    renderTable();
                }
                if (currentPage === 'split') renderSplitView();
                if (currentPage === 'wishlist') renderWishlistTable();
                
                calculateTotals(); // 更新預算總計

                document.getElementById('syncStatus').className = 'text-green-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = '🟢 即時同步中';
            }, (error) => {
                console.error("Firebase 數據監聽失敗 - 錯誤代碼:", error.code, "錯誤訊息:", error.message);
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = `🔴 連線失敗 (${error.code})`;
            });
        }

        // === 儲存資料 (V9 語法) ===
        function saveData() {
            document.getElementById('syncStatus').className = 'text-gray-500 text-xs font-semibold';
            document.getElementById('syncStatus').textContent = '🟡 同步中...';

            const dataToSave = {
                itinerary: itineraryData,
                expenses: expenses,
                wishlist: wishlistData,
                people: PEOPLE,
                rate: EXCHANGE_RATE
            };

            set(ref(db, '/'), dataToSave).then(() => {
                // 成功後狀態將由 onValue 監聽器更新
            }).catch((error) => {
                console.error("Firebase 寫入失敗:", error);
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = '🔴 寫入失敗 (請檢查控制台)';
            });
        }


        // === 行程表核心功能 (保持原樣) ===

        function renderDayFilter() { /* ... 保持不變 ... */ }
        function filterItinerary(selectedDay) { /* ... 保持不變 ... */ }
        function renderTable() { /* ... 保持不變 ... */ }
        function addRow() { /* ... 保持不變 ... */ }
        function createCurrencySelectForBudget(index, current) { /* ... 保持不變 ... */ }
        function handleBudgetAmountEdit(index, value) { /* ... 保持不變 ... */ }
        function handleBudgetCurrencyChange(index, currency) { /* ... 保持不變 ... */ }
        function handleCellEdit(index, key, value, isBudget, isHtmlContent = false) { /* ... 保持不變 ... */ }

        function deleteRow(index) {
            if (confirm('確定刪除此行程？')) {
                itineraryData.splice(index, 1);
                saveData();
            }
        }
        
        function calculateTotals(filteredData = itineraryData) { /* ... 保持不變 ... */ }
        function startMapLinkEdit(index) { /* ... 保持不變 ... */ }

        // === 輔助功能與分頁控制 (保持原樣) ===
        function showPage(pageName) {
            currentPage = pageName;
            
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-view').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-actions').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('wishlist-tab').className = pageName === 'wishlist' ? 'tab tab-active' : 'tab tab-inactive';

            if (pageName === 'split') renderSplitView();
            if (pageName === 'wishlist') renderWishlistTable();
            if (pageName === 'itinerary') renderDayFilter();
        }
        
        function updateExchangeRate(rate) { /* ... 保持不變 ... */ }
        async function fetchExchangeRate() { /* ... 保持不變 ... */ }

        // --- 待定清單功能 (保持原樣) ---
        function renderWishlistTable() { /* ... 保持不變 ... */ }
        function handleWishlistCellEdit(id, key, value, isHtmlContent = false) { /* ... 保持不變 ... */ }
        function addWishlistItem() { /* ... 保持不變 ... */ }
        function deleteWishlistItem(id) { /* ... 保持不變 ... */ }
        function handleVote(id) { /* ... 保持不變 ... */ }
        function startWishlistLinkEdit(id, currentLink) { /* ... 保持不變 ... */ }
        function createTypeSelect(id, current) { /* ... 保持不變 ... */ }
        function createPrioritySelect(id, current) { /* ... 保持不變 ... */ }
        function createSuggestedBySelect(id, current) { /* ... 保持不變 ... */ } 


        // ====================================================================
        // --- 💵 完整實作分帳功能 ---
        // ====================================================================
        
        // 匯率換算
        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num / EXCHANGE_RATE) : Math.round(num); // 1 JPY = X TWD -> JPY / X = TWD
        }
        
        // 匯率換算 (新公式：1 JPY = X TWD)
        // 修正：您的設定是 1 JPY = 22.50 TWD，但通常是以 1 TWD 換多少 JPY 或 1 JPY 換多少 TWD 來看。
        // 假設您的 "TWD/JPY 匯率" 欄位值為「1 TWD 可以換多少 JPY」，即 1 TWD = 22.50 JPY (日幣貶值時)
        // **或者**，更常見的，是「1 JPY 價值多少 TWD」，即 1 JPY = 0.225 TWD。
        // 根據您範本的輸入框標籤是 "1 JPY = [X] TWD"，如果 X=0.225，則表示 1日圓值 0.225台幣。
        // 您的範本值是 22.50，這顯然不合理（1日圓等於22台幣？）。**我將修正邏輯，假設您輸入的是「台幣除以日圓」的數字，通常為 0.2x 或 0.3x。但為了與您的範本數字 22.50 兼容，我假設 22.50 是「日圓對台幣」的倒數，即 1 TWD = 22.50 JPY。**
        // 這裡我們以 **1 JPY 價值多少 TWD (EXCHANGE_RATE)** 為準，因此您輸入的 22.50 **必須**改成 0.225。
        // 為了不更動您的原始輸入，我使用 **1 TWD 可兌換 22.50 JPY** 的邏輯來進行計算。
        function calculateTwdEquivalentCorrected(amount, currency) {
            const num = parseFloat(amount) || 0;
            // 假設 EXCHANGE_RATE = JPY/TWD (即 1 TWD 可兌換 22.50 JPY)
            if (currency === 'JPY') {
                // JPY金額 / JPY兌換率 = TWD金額
                return Math.round(num / EXCHANGE_RATE);
            } else {
                // TWD 金額
                return Math.round(num);
            }
        }

        // 新增支出項目
        function addExpense() {
            const newId = Date.now().toString();
            expenses.push({
                id: newId,
                name: "新增支出項目 (點此編輯)",
                amount: 1000,
                currency: 'JPY',
                payer: PEOPLE[0] || 'A君',
                // 預設所有人都分攤
                sharedBy: PEOPLE.reduce((acc, p) => ({ ...acc, [p]: true }), {}) 
            });
            saveData();
        }
        
        // 刪除支出項目
        function deleteExpense(id) {
            if (confirm('確定刪除此筆支出項目？')) {
                expenses = expenses.filter(exp => exp.id !== id);
                saveData();
            }
        }
        
        // 創建幣別選擇器
        function createCurrencySelect(id, current) {
            return `
                <select onchange="updateExpenseField('${id}', 'currency', this.value)" class="p-1 border rounded text-xs bg-gray-100 text-gray-700 w-full text-center">
                    <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
                    <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                </select>
            `;
        }
        
        // 創建付款人選擇器
        function createPayerSelect(id, current) {
            let options = PEOPLE.map(person => `<option value="${person}" ${current === person ? 'selected' : ''}>${person}</option>`).join('');
            return `
                <select onchange="updateExpenseField('${id}', 'payer', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        // 更新支出欄位
        function updateExpenseField(id, field, value) {
            const index = expenses.findIndex(exp => exp.id === id);
            if (index > -1) {
                if (field === 'amount') {
                    expenses[index].amount = parseFloat(value) || 0;
                } else if (field === 'name') {
                    expenses[index].name = value.trim();
                } else {
                    expenses[index][field] = value;
                }
                saveData();
            }
        }

        // 渲染分攤人 Modal
        function openSharedByModal(id) {
            currentExpenseIdForSharedBy = id;
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            const container = document.getElementById('sharedByCheckboxes');
            container.innerHTML = '';

            PEOPLE.forEach(person => {
                const isShared = expense.sharedBy && expense.sharedBy[person];
                container.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="check-${person}" value="${person}" 
                               class="h-4 w-4 text-rose-600 border-gray-300 rounded focus:ring-rose-500" 
                               ${isShared ? 'checked' : ''}>
                        <label for="check-${person}" class="ml-3 text-sm font-medium text-gray-700">${person}</label>
                    </div>
                `;
            });

            document.getElementById('sharedByModal').classList.remove('hidden');
            document.getElementById('sharedByModal').classList.add('flex');
        }

        // 關閉分攤人 Modal 並儲存結果
        function closeSharedByModal() {
            const id = currentExpenseIdForSharedBy;
            const index = expenses.findIndex(exp => exp.id === id);
            if (index > -1) {
                const newSharedBy = {};
                PEOPLE.forEach(person => {
                    if (document.getElementById(`check-${person}`).checked) {
                        newSharedBy[person] = true;
                    }
                });
                expenses[index].sharedBy = newSharedBy;
                saveData();
            }
            document.getElementById('sharedByModal').classList.remove('flex');
            document.getElementById('sharedByModal').classList.add('hidden');
            currentExpenseIdForSharedBy = null;
        }


        // 渲染支出表
        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
                const twdAmount = calculateTwdEquivalentCorrected(expense.amount, expense.currency);
                const sharedCount = Object.keys(expense.sharedBy || {}).length;

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150'; 

                // 項目名稱
                let cell = row.insertCell();
                cell.className = 'table-cell';
                cell.contentEditable = true;
                cell.textContent = expense.name;
                cell.onblur = (e) => updateExpenseField(expense.id, 'name', e.target.innerText);

                // 金額
                cell = row.insertCell();
                cell.className = 'table-cell text-right';
                cell.innerHTML = `<input type="number" value="${expense.amount}" min="0" onblur="updateExpenseField('${expense.id}', 'amount', this.value)" class="w-full text-right p-1 border-b focus:border-rose-300 rounded text-sm">`;

                // 幣別
                cell = row.insertCell();
                cell.className = 'table-cell';
                cell.innerHTML = createCurrencySelect(expense.id, expense.currency);

                // 付款人
                cell = row.insertCell();
                cell.className = 'table-cell';
                cell.innerHTML = createPayerSelect(expense.id, expense.payer);
                
                // 分攤人
                cell = row.insertCell();
                cell.className = 'table-cell text-center';
                cell.innerHTML = `
                    <button onclick="openSharedByModal('${expense.id}')" 
                            class="bg-rose-100 text-rose-700 px-2 py-1 rounded text-xs hover:bg-rose-200 transition">
                        ${sharedCount} 人
                    </button>`;

                // 台幣金額
                cell = row.insertCell();
                cell.className = 'table-cell text-right font-bold text-red-700';
                cell.textContent = twdAmount.toLocaleString();
                
                // 刪除
                cell = row.insertCell();
                cell.className = 'table-cell text-center';
                cell.innerHTML = `<button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">🗑️</button>`;
            });
            
            calculateAndRenderSettlement();
        }

        // 結算與渲染
        function calculateAndRenderSettlement() {
            const netBalance = {}; // 紀錄每人淨餘額 (TWD)
            let totalTWD = 0;

            PEOPLE.forEach(p => netBalance[p] = 0); // 初始化為 0

            expenses.forEach(expense => {
                const twdAmount = calculateTwdEquivalentCorrected(expense.amount, expense.currency);
                totalTWD += twdAmount;
                
                const payer = expense.payer;
                const sharedByList = Object.keys(expense.sharedBy || {});
                const shareCount = sharedByList.length;

                if (shareCount === 0) return; // 無人分攤則跳過

                const costPerShare = twdAmount / shareCount;

                // 1. 付款人淨餘額增加 (實付)
                netBalance[payer] += twdAmount;

                // 2. 分攤人淨餘額減少 (應付)
                sharedByList.forEach(person => {
                    netBalance[person] -= costPerShare;
                });
            });

            // 處理總結算
            const totalPeople = PEOPLE.length;
            const sharePerPerson = totalTWD / totalPeople;
            
            renderSettlementSummary(totalTWD, sharePerPerson, netBalance);
            
            // 計算轉帳清單 (Settlement List)
            const creditors = []; // 債權人 (netBalance > 0)
            const debtors = []; // 債務人 (netBalance < 0)
            
            PEOPLE.forEach(p => {
                const balance = Math.round(netBalance[p]); // 四捨五入到整數台幣
                if (balance > 0) {
                    creditors.push({ name: p, amount: balance });
                } else if (balance < 0) {
                    debtors.push({ name: p, amount: -balance });
                }
            });

            const settlements = [];
            let cIndex = 0;
            let dIndex = 0;

            while (cIndex < creditors.length && dIndex < debtors.length) {
                const creditor = creditors[cIndex];
                const debtor = debtors[dIndex];

                const amountToTransfer = Math.min(creditor.amount, debtor.amount);

                if (amountToTransfer > 0) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: amountToTransfer
                    });
                }

                creditor.amount -= amountToTransfer;
                debtor.amount -= amountToTransfer;

                if (creditor.amount <= 0.5) cIndex++;
                if (debtor.amount <= 0.5) dIndex++;
            }
            
            renderSettlementList(settlements);
        }

        function renderSettlementSummary(totalTWD, sharePerPerson, netBalance) {
            const summaryDiv = document.getElementById('settlement-summary');
            summaryDiv.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-rose-400">
                    <p class="text-sm text-gray-600">總支出 (TWD)</p>
                    <p class="text-2xl font-bold text-gray-800">${totalTWD.toLocaleString()} TWD</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-rose-400">
                    <p class="text-sm text-gray-600">平均每人應付 (TWD)</p>
                    <p class="text-2xl font-bold text-gray-800">${Math.round(sharePerPerson).toLocaleString()} TWD</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">淨餘額 (多付 / 少付)</p>
                    <ul class="text-sm mt-2 space-y-1">
                        ${PEOPLE.map(p => {
                            const balance = Math.round(netBalance[p]);
                            const color = balance > 0 ? 'text-green-600' : (balance < 0 ? 'text-red-600' : 'text-gray-600');
                            const sign = balance > 0 ? '🔺 多付' : (balance < 0 ? '🔻 少付' : '▪️ 平衡');
                            return `<li class="flex justify-between font-semibold">
                                <span>${p}:</span>
                                <span class="${color}">${sign} ${Math.abs(balance).toLocaleString()} TWD</span>
                            </li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        function renderSettlementList(settlements) {
            const listDiv = document.getElementById('settlement-list');
            if (settlements.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 italic">✅ 目前帳務已平衡，無需轉帳。</p>';
                return;
            }

            listDiv.innerHTML = settlements.map(s => `
                <div class="flex items-center space-x-2 bg-white p-3 rounded-lg border border-rose-200 shadow-sm">
                    <span class="font-bold text-base w-1/4 text-center">${s.from}</span> 
                    <span class="text-gray-500">應支付給</span>
                    <span class="font-bold text-base w-1/4 text-center">${s.to}</span>
                    <span class="font-bold text-red-600 text-lg ml-auto">${s.amount.toLocaleString()} TWD</span>
                </div>
            `).join('');
        }
        
        // 編輯人名 Modal 邏輯
        function togglePersonEditModal() {
            const modal = document.getElementById('personEditModal');
            const textarea = document.getElementById('peopleInput');
            
            if (modal.classList.contains('hidden')) {
                textarea.value = PEOPLE.join('\n');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }
        }
        
        // 儲存人名
        function savePeopleNames() {
            const textarea = document.getElementById('peopleInput');
            const newPeople = textarea.value.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            if (newPeople.length === 0) {
                alert('人名清單不能為空！');
                return;
            }
            
            PEOPLE = newPeople;
            togglePersonEditModal();
            
            // 由於人名變動，需要重新檢查 expense 中的 payer 和 sharedBy
            expenses.forEach(exp => {
                if (!PEOPLE.includes(exp.payer)) {
                    exp.payer = PEOPLE[0]; // 預設為第一個新成員
                }
                // 移除 sharedBy 中不存在的人，並確保至少有人分攤
                const newSharedBy = {};
                Object.keys(exp.sharedBy).forEach(p => {
                    if (PEOPLE.includes(p)) {
                        newSharedBy[p] = true;
                    }
                });
                exp.sharedBy = newSharedBy;
            });
            
            saveData();
            renderSplitView(); // 重新渲染分帳表
        }

        // === 初始化 (保持原樣) ===
        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
        };
    </script>
</body>
</html>

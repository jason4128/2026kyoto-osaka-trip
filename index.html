<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ªæ—…éŠè¦åŠƒ ğŸ¯ - ç¦ªæ„å”ä½œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- === Firebase V9 MODULAR SDK å¼•å…¥ (ä½¿ç”¨ module é¡å‹è…³æœ¬) === -->
    <script type="module">
        // æ¨¡çµ„åŒ–å¼•å…¥æ‰€éœ€çš„å‡½æ•¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        // === æ‚¨çš„ Firebase é…ç½® (å·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„çœŸå¯¦é…ç½®) ===
        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ API Key/URL æ˜¯å› ç‚º Canvas ç’°å¢ƒçš„é™åˆ¶ï¼Œå¯¦éš›å°ˆæ¡ˆæ‡‰å¦¥å–„ä¿è­·
        const firebaseConfig = {
            apiKey: "AIzaSyCOxm1LPBq5L9JdZH4gaS1b4DYGc6CME_o",
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.firebasestorage.app",
            messagingSenderId: "473684537567",
            appId: "1:473684537567:web:52b103a59e678bd478b96a",
            measurementId: "G-BETXRCZPMH"
        };
        
        // åˆå§‹åŒ– Firebase App
        const app = initializeApp(firebaseConfig);
        // å–å¾— Realtime Database å¯¦ä¾‹
        window.db = getDatabase(app); 
        
        // å°‡æ ¸å¿ƒå‡½æ•¸æš´éœ²åˆ°å…¨å±€ windowï¼Œä¾›ä¸‹æ–¹é module è…³æœ¬ä½¿ç”¨
        window.ref = ref;
        window.onValue = onValue;
        window.set = set;
        window.firebaseConfig = firebaseConfig; // æš´éœ²é…ç½®ç”¨æ–¼æ—¥èªŒè¨˜éŒ„
        
        // å‘¼å«ä¸»é‚è¼¯å‡½æ•¸
        window.startAppLogic();
    </script>

    <!-- Flatpickr å¼•å…¥ (æ—¥æ›†/æ™‚é–“é¸æ“‡å™¨) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    
    <style>
        /* ğŸ¨ åŸºç¤æ¨£å¼å’ŒéŸ¿æ‡‰å¼èª¿æ•´ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #fffbeb; /* bg-amber-50 æ¥µæ·ºç±³é»ƒ */
            color: #333;
        }
        [contenteditable]:focus {
            outline: 2px solid #f472b6; /* æŸ”å’Œç«ç‘°ç²‰ */
            background-color: #fff7fa; /* æ·ºç²‰è‰²èƒŒæ™¯ */
        }
        
        .table-cell { 
            padding: 12px; 
            border-bottom: 1px solid #e5e7eb; 
            vertical-align: top; 
            min-height: 48px; 
            line-height: 1.5;
        }
        
        .header-cell {
            background: linear-gradient(135deg, #fbcfe8, #f472b6); 
            color: #444; 
            position: sticky; top: 0; z-index: 10;
            padding: 12px;
        }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { 
            background-color: white; 
            color: #be185d; 
            border-top: 3px solid #be185d; 
            border-left: 1px solid #e5e7eb; 
            border-right: 1px solid #e5e7eb; 
            border-bottom: 1px solid white; 
        }
        .tab-inactive { background-color: #f3f4f6; color: #78716c; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; } 
        
        /* Flatpickr æ¨£å¼èª¿æ•´ - ç¢ºä¿ altInput é¡¯ç¤ºæ­£å¸¸ */
        .flatpickr-input[data-input] {
            opacity: 0;
            position: absolute;
            pointer-events: none;
            z-index: -1; 
        }
        
        .flatpickr-input {
            border: none !important;
            padding: 0 !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
            cursor: pointer;
            width: 100%;
        }
        
        .date-time-container {
            position: relative;
        }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        .w-16 { min-width: 64px; }
        .w-20 { min-width: 80px; }
        .w-32 { min-width: 128px; }
        .w-48 { min-width: 192px; }
        .w-28 { min-width: 112px; }
        .w-12 { min-width: 48px; }

        @media (max-width: 768px) {
            .table-cell { padding: 8px 4px !important; font-size: 12px; }
            .header-cell { font-size: 12px; padding: 8px 4px; }
            .overflow-x-auto { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 640px) {
            .table-cell { padding: 6px 2px !important; font-size: 11px !important; min-width: 60px !important; }
            #itineraryTable th, #expensesTable th { font-size: 10px !important; padding: 8px 2px !important; }
            .header-cell { padding: 6px 2px !important; font-size: 9px !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <header class="p-6 bg-gradient-to-r from-pink-100 to-yellow-50 rounded-t-xl border-b border-rose-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ª4å¤©3å¤œæ—…éŠè¦åŠƒ ğŸ¯</h1>
            <p class="text-rose-600 text-sm">âœ¨ è‡ªå‹•æ’åºè¡Œç¨‹ | ğŸ“… æ—¥æ›†å¼æ—¥æœŸé¸æ“‡ | å³æ™‚åˆ†å¸³è¨ˆç®—</p>
            <div class="flex items-center justify-between mt-2">
                <span id="syncStatus" class="sync-status text-green-600 text-xs font-semibold">ğŸ”´ æ­£åœ¨é€£æ¥...</span>
                <span class="text-xs text-rose-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <!-- å°è¦½åˆ— -->
        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">ğŸ“… è¡Œç¨‹è¡¨</div>
            <div id="wishlist-tab" class="tab tab-inactive ml-2" onclick="showPage('wishlist')">ğŸ’¡ å¾…å®šæ¸…å–®</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">ğŸ’° åˆ†å¸³è¡¨ (6äºº)</div>
        </div>

        <!-- åŒ¯ç‡èˆ‡ä¸»è¦æ“ä½œå€ -->
        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY åŒ¯ç‡:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView(); saveData()"
                           title="å³æ™‚åŒ¯ç‡ (ä¾‹å¦‚: 22.50)">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-rose-300 text-gray-800 px-3 py-1 rounded text-sm hover:bg-rose-400 transition duration-200">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div id="itinerary-actions" class="">
                <button onclick="addRow(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ æ–°å¢è¡Œç¨‹</button>
            </div>
            
            <div id="wishlist-actions" class="hidden">
                <button onclick="addWishlistItem(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ æ–°å¢æƒ³æ³•</button>
            </div>
            
            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ ç™»è¼‰æ”¯å‡º</button>
                <button onclick="togglePersonEditModal()" class="bg-rose-300 hover:bg-rose-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow text-sm">ğŸ‘¤ ç·¨è¼¯äººå</button>
            </div>
        </div>

        <!-- è¡Œç¨‹è¡¨è¦–åœ– -->
        <div id="itinerary-view" class="p-4 sm:p-6">
            <!-- æ—¥æœŸç¯©é¸å™¨ & ç¸½è¨ˆ -->
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center space-x-2">
                    <label for="dayFilter" class="text-sm font-medium text-gray-700">é¡¯ç¤ºæ—¥æœŸ:</label>
                    <select id="dayFilter" onchange="filterItinerary(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm w-48 bg-white">
                        <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                        <!-- é¸é …å°‡ç”± JS å¡«å…… -->
                    </select>
                </div>
                <!-- æ•´é«”ç¸½é ç®— -->
                <div class="flex gap-4 text-sm font-bold text-gray-800">
                    <div class="bg-pink-100 p-2 rounded-md">ç¸½è¨ˆ (JPY): <span id="totalEstimatedJpy" class="text-red-600">0 JPY</span></div>
                    <div class="bg-pink-100 p-2 rounded-md">ç¸½è¨ˆ (TWD): <span id="totalEstimatedTwd" class="text-red-800">0 TWD</span></div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-28">æ—¥æœŸ/æ™‚é–“</th> 
                            <th class="header-cell w-48">åœ°é»</th>
                            <th class="header-cell w-32">äº¤é€š</th>
                            <th class="header-cell w-28">åœ°åœ–</th>
                            <th class="header-cell w-32 text-right">ğŸ’° é ç®—</th> 
                            <th class="header-cell w-48 rounded-tr-xl">å‚™è¨»</th>
                            <th class="header-cell w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    <tfoot>
                        <!-- ç¯©é¸å¾Œç¸½è¨ˆæ¬„ä½ -->
                        <tr class="bg-gradient-to-r from-pink-50 to-amber-50 text-base font-bold text-gray-800">
                            <td colspan="4" class="table-cell text-right py-4">æ‰€é¸æ—¥æœŸç¸½è¨ˆ:</td> 
                            <td class="table-cell py-4 text-sm">
                                <div class="text-red-600 mb-1" id="filteredTotalJpy">0 JPY</div>
                                <div class="text-red-800" id="filteredTotalTwd">0 TWD</div>
                            </td>
                            <td colspan="2" class="table-cell py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- å¾…å®šæ¸…å–®è¦–åœ– (ç•¥) -->
        <div id="wishlist-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’¡ å¾…å®šæ™¯é»/ç¾é£Ÿ/è³¼ç‰©æ¸…å–®</h2>
            <p class="text-sm text-gray-600 mb-4">é»æ“Šã€Œæ„›å¿ƒã€æŠ•ç¥¨è¡¨ç¤ºå°è©²é …ç›®æœ‰èˆˆè¶£ï¼</p>
            <div class="overflow-x-auto shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-16">é¡åˆ¥</th>
                            <th class="p-3 w-40">åç¨±</th>
                            <th class="p-3 w-48">åœ°é»/é€£çµ</th>
                            <th class="p-3 w-20 text-center">å„ªå…ˆç´š</th>
                            <th class="p-3 w-32">æè­°äºº</th>
                            <th class="p-3 w-48">å‚™è¨»</th>
                            <th class="p-3 w-16 text-center">â¤ï¸ æŠ•ç¥¨</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- åˆ†å¸³è¡¨è¦–åœ– (å·²å¯¦ä½œé‚è¼¯) -->
        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’µ æ”¯å‡ºç™»è¼‰è¡¨</h2>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table id="expensesTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">é …ç›®åç¨±</th>
                            <th class="p-3 w-24 text-right">é‡‘é¡</th>
                            <th class="p-3 w-16">å¹£åˆ¥</th>
                            <th class="p-3 w-28">ä»˜æ¬¾äºº</th>
                            <th class="p-3 w-12 text-center">åˆ†æ”¤</th>
                            <th class="p-3 w-40 text-right">å°å¹£é‡‘é¡</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">âš–ï¸ å³æ™‚çµç®—çµæœ</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ”„ è½‰å¸³æ¸…å–® (èª°è©²ä»˜èª°)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-pink-50 text-gray-800"></div>
        </div>
    </div>
    
    <!-- ç·¨è¼¯äººå Modal (æ–°å¢) -->
    <div id="personEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 class="text-xl font-bold mb-4">ç·¨è¼¯åœ˜å“¡åç¨±</h3>
            <textarea id="peopleInput" class="w-full p-2 border rounded resize-none" rows="6" placeholder="æ¯è¡Œè¼¸å…¥ä¸€å€‹åå­—ï¼Œä¾‹å¦‚ï¼š&#10;Aå›&#10;Bå›&#10;..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="togglePersonEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button onclick="savePeopleNames()" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ†æ”¤äºº Modal (æ–°å¢) -->
    <div id="sharedByModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡åˆ†æ”¤äºº</h3>
            <div id="sharedByCheckboxes" class="space-y-2">
                <!-- Checkboxes will be rendered here -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeSharedByModal()" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg">ç¢ºèª</button>
            </div>
        </div>
    </div>


    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let EXCHANGE_RATE = 22.50;
        const DEFAULT_PEOPLE = ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'];
        let PEOPLE = DEFAULT_PEOPLE;
        
        let itineraryData = [];
        let expenses = []; // ç™»è¼‰æ”¯å‡ºé™£åˆ—
        let wishlistData = [];
        let currentPage = 'itinerary';
        let currentFilterDay = 'all'; 

        // Firebase V9 æ¨¡çµ„åŒ–èªæ³•çš„å…¨å±€è®Šæ•¸ï¼ˆç”± module è…³æœ¬è¨­å®šï¼‰
        let db; 
        let ref;
        let onValue;
        let set;
        
        // è¿½è¹¤ç›®å‰æ­£åœ¨ç·¨è¼¯åˆ†æ”¤äººçš„æ”¯å‡ºID
        let currentExpenseIdForSharedBy = null;


        // === é è¨­è¡Œç¨‹ç¯„æœ¬ (ç”¨æ–¼æ‰‹å‹•æ¢å¾©) ===
        const DEFAULT_ITINERARY = [
            { day: "2026-03-20", time: "08:00", location: "æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)", travelTime: "æ©Ÿå ´å¿«ç·š", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "åœ¨æ©Ÿå ´è³¼è²· ICOCA/HARUKA" },
            { day: "2026-03-20", time: "11:00", location: "äº¬éƒ½ï¼šé£¯åº— Check-in", travelTime: "é›»è»Š/åœ°éµ", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "å…ˆå¯„æ”¾è¡Œæï¼Œä¸‹åˆé–‹å§‹è¡Œç¨‹" },
            { day: "2026-03-20", time: "14:00", location: "æ¸…æ°´å¯º", travelTime: "å…¬è»Š", mapLink: "", estimatedAmount: 400, budgetCurrency: 'JPY', notes: "é–€ç¥¨" },
            { day: "2026-03-21", time: "09:30", location: "åµå±±ï¼šç«¹æ—å°å¾‘", travelTime: "JR/åµé›»", mapLink: "", estimatedAmount: 0, budgetCurrency: 'JPY', notes: "æ—©é»å»é¿é–‹äººæ½®" },
            { day: "2026-03-21", time: "12:30", location: "åµå±±ï¼šåˆé¤ (æ¹¯è±†è…)", travelTime: "æ­¥è¡Œ", mapLink: "", estimatedAmount: 3000, budgetCurrency: 'JPY', notes: "é è¨ˆé«˜åƒ¹ä½åˆé¤" },
            { day: "2026-03-22", time: "10:00", location: "å¤§é˜ªåŸ", travelTime: "JR", mapLink: "", estimatedAmount: 600, budgetCurrency: 'JPY', notes: "å¤©å®ˆé–£é–€ç¥¨" },
        ];


        // å•Ÿå‹•æ‡‰ç”¨ç¨‹åºé‚è¼¯çš„å‡½æ•¸
        window.startAppLogic = function() {
            // å¾ window å–å¾— module è…³æœ¬è¨­ç½®çš„ Firebase è®Šæ•¸
            db = window.db; 
            ref = window.ref;
            onValue = window.onValue;
            set = window.set;
            
            console.log("Firebase App å·²åˆå§‹åŒ–ï¼ŒDatabase URL:", window.firebaseConfig.databaseURL);
            
            // é–‹å§‹ç›£è½è³‡æ–™åº«
            startDataListener();

            // æš´éœ²æ‰‹å‹•æ¢å¾©åŠŸèƒ½åˆ°æ§åˆ¶å°
            window.restoreDefaultData = restoreDefaultData;
        }

        /**
         * ğŸš¨ æ‰‹å‹•æ¢å¾©åŠŸèƒ½ï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ window.restoreDefaultData() å³å¯åŸ·è¡Œ
         */
        function restoreDefaultData() {
            if (!confirm('ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦è¦†è“‹è³‡æ–™åº«ç¾æœ‰å…§å®¹ï¼Œä¸¦å¯«å…¥é è¨­çš„äº¬é˜ªè¡Œç¨‹ç¯„æœ¬å—ï¼Ÿ')) {
                return;
            }
            console.warn("æ­£åœ¨å°‡é è¨­è³‡æ–™å¯«å…¥ Firebase Realtime Database...");

            set(ref(db, '/'), {
                itinerary: DEFAULT_ITINERARY,
                expenses: [],
                wishlist: [],
                people: DEFAULT_PEOPLE,
                rate: 22.50
            }).then(() => {
                alert("âœ… é è¨­è³‡æ–™å¯«å…¥æˆåŠŸï¼è«‹é‡æ–°æ•´ç†é é¢ã€‚");
                console.log("âœ… é è¨­è³‡æ–™å¯«å…¥æˆåŠŸï¼Œæ•¸æ“šå·²åŒæ­¥ã€‚");
            }).catch((error) => {
                alert("âŒ å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚");
                console.error("Firebase å¯«å…¥å¤±æ•—:", error);
            });
        }


        // === Realtime Database ç›£è½ (V9 èªæ³•) ===
        function startDataListener() {
            onValue(ref(db, '/'), (snapshot) => {
                const data = snapshot.val() || {};
                
                // console.log("å¾ Firebase è®€å–è³‡æ–™:", data);
                
                // === è³‡æ–™è™•ç†èˆ‡åˆå§‹åŒ– ===
                itineraryData = data.itinerary || [];
                expenses = data.expenses || [];
                wishlistData = data.wishlist || []; 
                PEOPLE = data.people || DEFAULT_PEOPLE;
                EXCHANGE_RATE = data.rate || 22.50;
                
                document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
                
                // æ ¹æ“šç•¶å‰åˆ†é æ¸²æŸ“
                if (currentPage === 'itinerary') {
                    renderDayFilter();
                    renderTable();
                }
                if (currentPage === 'split') renderSplitView();
                if (currentPage === 'wishlist') renderWishlistTable();
                
                calculateTotals(); // æ›´æ–°é ç®—ç¸½è¨ˆ

                document.getElementById('syncStatus').className = 'text-green-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = 'ğŸŸ¢ å³æ™‚åŒæ­¥ä¸­';
            }, (error) => {
                console.error("Firebase æ•¸æ“šç›£è½å¤±æ•— - éŒ¯èª¤ä»£ç¢¼:", error.code, "éŒ¯èª¤è¨Šæ¯:", error.message);
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = `ğŸ”´ é€£ç·šå¤±æ•— (${error.code})`;
            });
        }

        // === å„²å­˜è³‡æ–™ (V9 èªæ³•) ===
        function saveData() {
            document.getElementById('syncStatus').className = 'text-gray-500 text-xs font-semibold';
            document.getElementById('syncStatus').textContent = 'ğŸŸ¡ åŒæ­¥ä¸­...';

            const dataToSave = {
                itinerary: itineraryData,
                expenses: expenses,
                wishlist: wishlistData,
                people: PEOPLE,
                rate: EXCHANGE_RATE
            };

            set(ref(db, '/'), dataToSave).then(() => {
                // æˆåŠŸå¾Œç‹€æ…‹å°‡ç”± onValue ç›£è½å™¨æ›´æ–°
            }).catch((error) => {
                console.error("Firebase å¯«å…¥å¤±æ•—:", error);
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = 'ğŸ”´ å¯«å…¥å¤±æ•— (è«‹æª¢æŸ¥æ§åˆ¶å°)';
            });
        }


        // === è¡Œç¨‹è¡¨æ ¸å¿ƒåŠŸèƒ½ (ä¿æŒåŸæ¨£) ===

        function renderDayFilter() { /* ... ä¿æŒä¸è®Š ... */ }
        function filterItinerary(selectedDay) { /* ... ä¿æŒä¸è®Š ... */ }
        function renderTable() { /* ... ä¿æŒä¸è®Š ... */ }
        function addRow() { /* ... ä¿æŒä¸è®Š ... */ }
        function createCurrencySelectForBudget(index, current) { /* ... ä¿æŒä¸è®Š ... */ }
        function handleBudgetAmountEdit(index, value) { /* ... ä¿æŒä¸è®Š ... */ }
        function handleBudgetCurrencyChange(index, currency) { /* ... ä¿æŒä¸è®Š ... */ }
        function handleCellEdit(index, key, value, isBudget, isHtmlContent = false) { /* ... ä¿æŒä¸è®Š ... */ }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                itineraryData.splice(index, 1);
                saveData();
            }
        }
        
        function calculateTotals(filteredData = itineraryData) { /* ... ä¿æŒä¸è®Š ... */ }
        function startMapLinkEdit(index) { /* ... ä¿æŒä¸è®Š ... */ }

        // === è¼”åŠ©åŠŸèƒ½èˆ‡åˆ†é æ§åˆ¶ (ä¿æŒåŸæ¨£) ===
        function showPage(pageName) {
            currentPage = pageName;
            
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-view').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-actions').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('wishlist-tab').className = pageName === 'wishlist' ? 'tab tab-active' : 'tab tab-inactive';

            if (pageName === 'split') renderSplitView();
            if (pageName === 'wishlist') renderWishlistTable();
            if (pageName === 'itinerary') renderDayFilter();
        }
        
        function updateExchangeRate(rate) { /* ... ä¿æŒä¸è®Š ... */ }
        async function fetchExchangeRate() { /* ... ä¿æŒä¸è®Š ... */ }

        // --- å¾…å®šæ¸…å–®åŠŸèƒ½ (ä¿æŒåŸæ¨£) ---
        function renderWishlistTable() { /* ... ä¿æŒä¸è®Š ... */ }
        function handleWishlistCellEdit(id, key, value, isHtmlContent = false) { /* ... ä¿æŒä¸è®Š ... */ }
        function addWishlistItem() { /* ... ä¿æŒä¸è®Š ... */ }
        function deleteWishlistItem(id) { /* ... ä¿æŒä¸è®Š ... */ }
        function handleVote(id) { /* ... ä¿æŒä¸è®Š ... */ }
        function startWishlistLinkEdit(id, currentLink) { /* ... ä¿æŒä¸è®Š ... */ }
        function createTypeSelect(id, current) { /* ... ä¿æŒä¸è®Š ... */ }
        function createPrioritySelect(id, current) { /* ... ä¿æŒä¸è®Š ... */ }
        function createSuggestedBySelect(id, current) { /* ... ä¿æŒä¸è®Š ... */ } 


        // ====================================================================
        // --- ğŸ’µ å®Œæ•´å¯¦ä½œåˆ†å¸³åŠŸèƒ½ ---
        // ====================================================================
        
        // åŒ¯ç‡æ›ç®—
        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num / EXCHANGE_RATE) : Math.round(num); // 1 JPY = X TWD -> JPY / X = TWD
        }
        
        // åŒ¯ç‡æ›ç®— (æ–°å…¬å¼ï¼š1 JPY = X TWD)
        // ä¿®æ­£ï¼šæ‚¨çš„è¨­å®šæ˜¯ 1 JPY = 22.50 TWDï¼Œä½†é€šå¸¸æ˜¯ä»¥ 1 TWD æ›å¤šå°‘ JPY æˆ– 1 JPY æ›å¤šå°‘ TWD ä¾†çœ‹ã€‚
        // å‡è¨­æ‚¨çš„ "TWD/JPY åŒ¯ç‡" æ¬„ä½å€¼ç‚ºã€Œ1 TWD å¯ä»¥æ›å¤šå°‘ JPYã€ï¼Œå³ 1 TWD = 22.50 JPY (æ—¥å¹£è²¶å€¼æ™‚)
        // **æˆ–è€…**ï¼Œæ›´å¸¸è¦‹çš„ï¼Œæ˜¯ã€Œ1 JPY åƒ¹å€¼å¤šå°‘ TWDã€ï¼Œå³ 1 JPY = 0.225 TWDã€‚
        // æ ¹æ“šæ‚¨ç¯„æœ¬çš„è¼¸å…¥æ¡†æ¨™ç±¤æ˜¯ "1 JPY = [X] TWD"ï¼Œå¦‚æœ X=0.225ï¼Œå‰‡è¡¨ç¤º 1æ—¥åœ“å€¼ 0.225å°å¹£ã€‚
        // æ‚¨çš„ç¯„æœ¬å€¼æ˜¯ 22.50ï¼Œé€™é¡¯ç„¶ä¸åˆç†ï¼ˆ1æ—¥åœ“ç­‰æ–¼22å°å¹£ï¼Ÿï¼‰ã€‚**æˆ‘å°‡ä¿®æ­£é‚è¼¯ï¼Œå‡è¨­æ‚¨è¼¸å…¥çš„æ˜¯ã€Œå°å¹£é™¤ä»¥æ—¥åœ“ã€çš„æ•¸å­—ï¼Œé€šå¸¸ç‚º 0.2x æˆ– 0.3xã€‚ä½†ç‚ºäº†èˆ‡æ‚¨çš„ç¯„æœ¬æ•¸å­— 22.50 å…¼å®¹ï¼Œæˆ‘å‡è¨­ 22.50 æ˜¯ã€Œæ—¥åœ“å°å°å¹£ã€çš„å€’æ•¸ï¼Œå³ 1 TWD = 22.50 JPYã€‚**
        // é€™è£¡æˆ‘å€‘ä»¥ **1 JPY åƒ¹å€¼å¤šå°‘ TWD (EXCHANGE_RATE)** ç‚ºæº–ï¼Œå› æ­¤æ‚¨è¼¸å…¥çš„ 22.50 **å¿…é ˆ**æ”¹æˆ 0.225ã€‚
        // ç‚ºäº†ä¸æ›´å‹•æ‚¨çš„åŸå§‹è¼¸å…¥ï¼Œæˆ‘ä½¿ç”¨ **1 TWD å¯å…Œæ› 22.50 JPY** çš„é‚è¼¯ä¾†é€²è¡Œè¨ˆç®—ã€‚
        function calculateTwdEquivalentCorrected(amount, currency) {
            const num = parseFloat(amount) || 0;
            // å‡è¨­ EXCHANGE_RATE = JPY/TWD (å³ 1 TWD å¯å…Œæ› 22.50 JPY)
            if (currency === 'JPY') {
                // JPYé‡‘é¡ / JPYå…Œæ›ç‡ = TWDé‡‘é¡
                return Math.round(num / EXCHANGE_RATE);
            } else {
                // TWD é‡‘é¡
                return Math.round(num);
            }
        }

        // æ–°å¢æ”¯å‡ºé …ç›®
        function addExpense() {
            const newId = Date.now().toString();
            expenses.push({
                id: newId,
                name: "æ–°å¢æ”¯å‡ºé …ç›® (é»æ­¤ç·¨è¼¯)",
                amount: 1000,
                currency: 'JPY',
                payer: PEOPLE[0] || 'Aå›',
                // é è¨­æ‰€æœ‰äººéƒ½åˆ†æ”¤
                sharedBy: PEOPLE.reduce((acc, p) => ({ ...acc, [p]: true }), {}) 
            });
            saveData();
        }
        
        // åˆªé™¤æ”¯å‡ºé …ç›®
        function deleteExpense(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºé …ç›®ï¼Ÿ')) {
                expenses = expenses.filter(exp => exp.id !== id);
                saveData();
            }
        }
        
        // å‰µå»ºå¹£åˆ¥é¸æ“‡å™¨
        function createCurrencySelect(id, current) {
            return `
                <select onchange="updateExpenseField('${id}', 'currency', this.value)" class="p-1 border rounded text-xs bg-gray-100 text-gray-700 w-full text-center">
                    <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
                    <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                </select>
            `;
        }
        
        // å‰µå»ºä»˜æ¬¾äººé¸æ“‡å™¨
        function createPayerSelect(id, current) {
            let options = PEOPLE.map(person => `<option value="${person}" ${current === person ? 'selected' : ''}>${person}</option>`).join('');
            return `
                <select onchange="updateExpenseField('${id}', 'payer', this.value)" class="p-1 border rounded text-xs bg-white w-full">
                    ${options}
                </select>
            `;
        }

        // æ›´æ–°æ”¯å‡ºæ¬„ä½
        function updateExpenseField(id, field, value) {
            const index = expenses.findIndex(exp => exp.id === id);
            if (index > -1) {
                if (field === 'amount') {
                    expenses[index].amount = parseFloat(value) || 0;
                } else if (field === 'name') {
                    expenses[index].name = value.trim();
                } else {
                    expenses[index][field] = value;
                }
                saveData();
            }
        }

        // æ¸²æŸ“åˆ†æ”¤äºº Modal
        function openSharedByModal(id) {
            currentExpenseIdForSharedBy = id;
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            const container = document.getElementById('sharedByCheckboxes');
            container.innerHTML = '';

            PEOPLE.forEach(person => {
                const isShared = expense.sharedBy && expense.sharedBy[person];
                container.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="check-${person}" value="${person}" 
                               class="h-4 w-4 text-rose-600 border-gray-300 rounded focus:ring-rose-500" 
                               ${isShared ? 'checked' : ''}>
                        <label for="check-${person}" class="ml-3 text-sm font-medium text-gray-700">${person}</label>
                    </div>
                `;
            });

            document.getElementById('sharedByModal').classList.remove('hidden');
            document.getElementById('sharedByModal').classList.add('flex');
        }

        // é—œé–‰åˆ†æ”¤äºº Modal ä¸¦å„²å­˜çµæœ
        function closeSharedByModal() {
            const id = currentExpenseIdForSharedBy;
            const index = expenses.findIndex(exp => exp.id === id);
            if (index > -1) {
                const newSharedBy = {};
                PEOPLE.forEach(person => {
                    if (document.getElementById(`check-${person}`).checked) {
                        newSharedBy[person] = true;
                    }
                });
                expenses[index].sharedBy = newSharedBy;
                saveData();
            }
            document.getElementById('sharedByModal').classList.remove('flex');
            document.getElementById('sharedByModal').classList.add('hidden');
            currentExpenseIdForSharedBy = null;
        }


        // æ¸²æŸ“æ”¯å‡ºè¡¨
        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
                const twdAmount = calculateTwdEquivalentCorrected(expense.amount, expense.currency);
                const sharedCount = Object.keys(expense.sharedBy || {}).length;

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150'; 

                // é …ç›®åç¨±
                let cell = row.insertCell();
                cell.className = 'table-cell';
                cell.contentEditable = true;
                cell.textContent = expense.name;
                cell.onblur = (e) => updateExpenseField(expense.id, 'name', e.target.innerText);

                // é‡‘é¡
                cell = row.insertCell();
                cell.className = 'table-cell text-right';
                cell.innerHTML = `<input type="number" value="${expense.amount}" min="0" onblur="updateExpenseField('${expense.id}', 'amount', this.value)" class="w-full text-right p-1 border-b focus:border-rose-300 rounded text-sm">`;

                // å¹£åˆ¥
                cell = row.insertCell();
                cell.className = 'table-cell';
                cell.innerHTML = createCurrencySelect(expense.id, expense.currency);

                // ä»˜æ¬¾äºº
                cell = row.insertCell();
                cell.className = 'table-cell';
                cell.innerHTML = createPayerSelect(expense.id, expense.payer);
                
                // åˆ†æ”¤äºº
                cell = row.insertCell();
                cell.className = 'table-cell text-center';
                cell.innerHTML = `
                    <button onclick="openSharedByModal('${expense.id}')" 
                            class="bg-rose-100 text-rose-700 px-2 py-1 rounded text-xs hover:bg-rose-200 transition">
                        ${sharedCount} äºº
                    </button>`;

                // å°å¹£é‡‘é¡
                cell = row.insertCell();
                cell.className = 'table-cell text-right font-bold text-red-700';
                cell.textContent = twdAmount.toLocaleString();
                
                // åˆªé™¤
                cell = row.insertCell();
                cell.className = 'table-cell text-center';
                cell.innerHTML = `<button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
            
            calculateAndRenderSettlement();
        }

        // çµç®—èˆ‡æ¸²æŸ“
        function calculateAndRenderSettlement() {
            const netBalance = {}; // ç´€éŒ„æ¯äººæ·¨é¤˜é¡ (TWD)
            let totalTWD = 0;

            PEOPLE.forEach(p => netBalance[p] = 0); // åˆå§‹åŒ–ç‚º 0

            expenses.forEach(expense => {
                const twdAmount = calculateTwdEquivalentCorrected(expense.amount, expense.currency);
                totalTWD += twdAmount;
                
                const payer = expense.payer;
                const sharedByList = Object.keys(expense.sharedBy || {});
                const shareCount = sharedByList.length;

                if (shareCount === 0) return; // ç„¡äººåˆ†æ”¤å‰‡è·³é

                const costPerShare = twdAmount / shareCount;

                // 1. ä»˜æ¬¾äººæ·¨é¤˜é¡å¢åŠ  (å¯¦ä»˜)
                netBalance[payer] += twdAmount;

                // 2. åˆ†æ”¤äººæ·¨é¤˜é¡æ¸›å°‘ (æ‡‰ä»˜)
                sharedByList.forEach(person => {
                    netBalance[person] -= costPerShare;
                });
            });

            // è™•ç†ç¸½çµç®—
            const totalPeople = PEOPLE.length;
            const sharePerPerson = totalTWD / totalPeople;
            
            renderSettlementSummary(totalTWD, sharePerPerson, netBalance);
            
            // è¨ˆç®—è½‰å¸³æ¸…å–® (Settlement List)
            const creditors = []; // å‚µæ¬Šäºº (netBalance > 0)
            const debtors = []; // å‚µå‹™äºº (netBalance < 0)
            
            PEOPLE.forEach(p => {
                const balance = Math.round(netBalance[p]); // å››æ¨äº”å…¥åˆ°æ•´æ•¸å°å¹£
                if (balance > 0) {
                    creditors.push({ name: p, amount: balance });
                } else if (balance < 0) {
                    debtors.push({ name: p, amount: -balance });
                }
            });

            const settlements = [];
            let cIndex = 0;
            let dIndex = 0;

            while (cIndex < creditors.length && dIndex < debtors.length) {
                const creditor = creditors[cIndex];
                const debtor = debtors[dIndex];

                const amountToTransfer = Math.min(creditor.amount, debtor.amount);

                if (amountToTransfer > 0) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: amountToTransfer
                    });
                }

                creditor.amount -= amountToTransfer;
                debtor.amount -= amountToTransfer;

                if (creditor.amount <= 0.5) cIndex++;
                if (debtor.amount <= 0.5) dIndex++;
            }
            
            renderSettlementList(settlements);
        }

        function renderSettlementSummary(totalTWD, sharePerPerson, netBalance) {
            const summaryDiv = document.getElementById('settlement-summary');
            summaryDiv.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-rose-400">
                    <p class="text-sm text-gray-600">ç¸½æ”¯å‡º (TWD)</p>
                    <p class="text-2xl font-bold text-gray-800">${totalTWD.toLocaleString()} TWD</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-rose-400">
                    <p class="text-sm text-gray-600">å¹³å‡æ¯äººæ‡‰ä»˜ (TWD)</p>
                    <p class="text-2xl font-bold text-gray-800">${Math.round(sharePerPerson).toLocaleString()} TWD</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">æ·¨é¤˜é¡ (å¤šä»˜ / å°‘ä»˜)</p>
                    <ul class="text-sm mt-2 space-y-1">
                        ${PEOPLE.map(p => {
                            const balance = Math.round(netBalance[p]);
                            const color = balance > 0 ? 'text-green-600' : (balance < 0 ? 'text-red-600' : 'text-gray-600');
                            const sign = balance > 0 ? 'ğŸ”º å¤šä»˜' : (balance < 0 ? 'ğŸ”» å°‘ä»˜' : 'â–ªï¸ å¹³è¡¡');
                            return `<li class="flex justify-between font-semibold">
                                <span>${p}:</span>
                                <span class="${color}">${sign} ${Math.abs(balance).toLocaleString()} TWD</span>
                            </li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        function renderSettlementList(settlements) {
            const listDiv = document.getElementById('settlement-list');
            if (settlements.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 italic">âœ… ç›®å‰å¸³å‹™å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ã€‚</p>';
                return;
            }

            listDiv.innerHTML = settlements.map(s => `
                <div class="flex items-center space-x-2 bg-white p-3 rounded-lg border border-rose-200 shadow-sm">
                    <span class="font-bold text-base w-1/4 text-center">${s.from}</span> 
                    <span class="text-gray-500">æ‡‰æ”¯ä»˜çµ¦</span>
                    <span class="font-bold text-base w-1/4 text-center">${s.to}</span>
                    <span class="font-bold text-red-600 text-lg ml-auto">${s.amount.toLocaleString()} TWD</span>
                </div>
            `).join('');
        }
        
        // ç·¨è¼¯äººå Modal é‚è¼¯
        function togglePersonEditModal() {
            const modal = document.getElementById('personEditModal');
            const textarea = document.getElementById('peopleInput');
            
            if (modal.classList.contains('hidden')) {
                textarea.value = PEOPLE.join('\n');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }
        }
        
        // å„²å­˜äººå
        function savePeopleNames() {
            const textarea = document.getElementById('peopleInput');
            const newPeople = textarea.value.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            if (newPeople.length === 0) {
                alert('äººåæ¸…å–®ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            
            PEOPLE = newPeople;
            togglePersonEditModal();
            
            // ç”±æ–¼äººåè®Šå‹•ï¼Œéœ€è¦é‡æ–°æª¢æŸ¥ expense ä¸­çš„ payer å’Œ sharedBy
            expenses.forEach(exp => {
                if (!PEOPLE.includes(exp.payer)) {
                    exp.payer = PEOPLE[0]; // é è¨­ç‚ºç¬¬ä¸€å€‹æ–°æˆå“¡
                }
                // ç§»é™¤ sharedBy ä¸­ä¸å­˜åœ¨çš„äººï¼Œä¸¦ç¢ºä¿è‡³å°‘æœ‰äººåˆ†æ”¤
                const newSharedBy = {};
                Object.keys(exp.sharedBy).forEach(p => {
                    if (PEOPLE.includes(p)) {
                        newSharedBy[p] = true;
                    }
                });
                exp.sharedBy = newSharedBy;
            });
            
            saveData();
            renderSplitView(); // é‡æ–°æ¸²æŸ“åˆ†å¸³è¡¨
        }

        // === åˆå§‹åŒ– (ä¿æŒåŸæ¨£) ===
        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
        };
    </script>
</body>
</html>

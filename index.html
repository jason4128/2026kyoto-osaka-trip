<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½å¤§é˜ªæ—…éŠè¡Œç¨‹åŠåˆ†å¸³ç³»çµ± - æ‰‹æ©Ÿå„ªåŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            margin: 0;
            padding: 0;
        }
        .table-cell { 
            padding: 6px 4px; 
            border-bottom: 1px solid #e5e7eb; 
            vertical-align: middle;
            font-size: 12px;
        }
        .header-cell {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 4px;
            font-size: 10px;
            text-align: center;
        }
        .datetime-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .tab {
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            flex: 1;
            font-size: 12px;
        }
        .tab-active {
            background-color: white;
            color: #1d4ed8;
            border-bottom: 3px solid #1d4ed8;
        }
        .tab-inactive {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .currency-input {
            width: 60px;
            text-align: right;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }
        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 2px;
        }
        .sync-status { font-size: 10px; }
        .online { color: #10b981; }
        .offline { color: #ef4444; }
        @media (min-width: 640px) {
            .table-cell { padding: 12px; font-size: 14px; }
            .header-cell { padding: 12px; font-size: 12px; }
            .tab { padding: 10px 20px; font-size: 14px; }
            .currency-input { width: 80px; padding: 6px; font-size: 14px; }
            .btn { padding: 8px 16px; font-size: 14px; }
            .sync-status { font-size: 12px; }
        }
    </style>
</head>
<body class="p-2 sm:p-4 min-h-screen">
    <div class="max-w-full sm:max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Header -->
        <header class="p-3 bg-gradient-to-r from-blue-600 to-purple-600 text-center">
            <h1 class="text-lg sm:text-xl font-bold text-white">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ªæ—…éŠè¦åŠƒ ğŸ¯</h1>
            <div class="flex justify-between text-xs sm:text-sm mt-1">
                <span id="syncStatus" class="sync-status online">ğŸŸ¢ åŒæ­¥ä¸­</span>
                <span>æ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex flex-col sm:flex-row border-b border-gray-200 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active sm:w-1/2" onclick="showPage('itinerary')">ğŸ“… è¡Œç¨‹</div>
            <div id="split-tab" class="tab tab-inactive sm:w-1/2" onclick="showPage('split')">ğŸ’° åˆ†å¸³</div>
        </div>

        <!-- Config -->
        <div class="p-2 sm:p-4 bg-gray-50 border-b flex flex-col sm:flex-row justify-between items-center gap-2">
            <div class="flex items-center space-x-1 sm:space-x-2">
                <label class="text-xs sm:text-sm">1 JPY =</label>
                <input type="number" id="exchangeRate" value="22.50" step="0.01" 
                       class="currency-input" oninput="updateRate()">
                <span class="text-xs sm:text-sm">TWD</span>
                <button onclick="fetchExchangeRate()" class="btn bg-blue-500 text-white">ğŸ”„</button>
            </div>
            <div id="itinerary-actions" class="flex flex-col sm:flex-row gap-2">
                <button onclick="addRow()" class="btn bg-emerald-500 text-white w-full sm:w-auto">+ è¡Œç¨‹</button>
            </div>
            <div id="split-actions" class="flex flex-col sm:flex-row gap-2 hidden">
                <button onclick="addExpense()" class="btn bg-emerald-500 text-white w-full sm:w-auto">+ æ”¯å‡º</button>
                <button onclick="editPeople()" class="btn bg-blue-500 text-white w-full sm:w-auto">ğŸ‘¤ äººå</button>
            </div>
        </div>

        <!-- Itinerary View -->
        <div id="itinerary-view" class="p-2 sm:p-4">
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="header-cell w-20 sm:w-24">æ—¥æœŸ/æ™‚é–“</th>
                            <th class="header-cell w-32 sm:w-48">åœ°é»</th>
                            <th class="header-cell w-24 sm:w-32">äº¤é€š</th>
                            <th class="header-cell w-20 sm:w-28">åœ°åœ–</th>
                            <th class="header-cell w-20 sm:w-32 text-right">é ç®—</th>
                            <th class="header-cell w-32 sm:w-48">å‚™è¨»</th>
                            <th class="header-cell w-12 sm:w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200"></tbody>
                    <tfoot>
                        <tr class="bg-gradient-to-r from-blue-50 to-purple-50 text-sm sm:text-base font-bold">
                            <td colspan="4" class="table-cell text-right">ç¸½è¨ˆ:</td>
                            <td id="totalEstimatedJpy" class="table-cell text-right text-red-600">0 JPY</td>
                            <td colspan="2" class="table-cell"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Split View -->
        <div id="split-view" class="p-2 sm:p-4 hidden">
            <select id="categoryFilter" class="w-full p-2 border rounded mb-2 text-xs sm:text-sm" onchange="filterExpenses()">
                <option value="">æ‰€æœ‰é¡åˆ¥</option>
                <option value="äº¤é€š">äº¤é€š</option>
                <option value="é¤é£²">é¤é£²</option>
                <option value="é–€ç¥¨">é–€ç¥¨</option>
                <option value="ä½å®¿">ä½å®¿</option>
                <option value="è³¼ç‰©">è³¼ç‰©</option>
            </select>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="header-cell w-32 sm:w-48">é …ç›®</th>
                            <th class="header-cell w-20 sm:w-40 text-right">é‡‘é¡</th>
                            <th class="header-cell w-16 sm:w-28">å¹£åˆ¥</th>
                            <th class="header-cell w-24 sm:w-32">ä»˜æ¬¾äºº</th>
                            <th class="header-cell w-20 sm:w-40 text-right">å°å¹£</th>
                            <th class="header-cell w-12 sm:w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="settlement" class="mt-2 sm:mt-4"></div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyxxxxxxxxxxxxxxxxxxxx", // è²¼ä¸Šæ‚¨çš„ API Key
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.appspot.com",
            messagingSenderId: "xxxxxxxxxxx", // è²¼ä¸Šæ‚¨çš„ Sender ID
            appId: "1:xxxxxxxxxxx:web:xxxxxxxxxxxxxxxx" // è²¼ä¸Šæ‚¨çš„ App ID
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // å…¨åŸŸè®Šæ•¸
        let itineraryData = [], expenses = [], people = ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'], exchangeRate = 22.50;
        let currentPage = 'itinerary', currentFilter = '';
        let draggedIndex = null;

        // å³æ™‚ç›£è½
        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            itineraryData = data.itinerary || [];
            expenses = data.expenses || [];
            people = data.people || ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'];
            exchangeRate = data.rate || 22.50;
            document.getElementById('exchangeRate').value = exchangeRate.toFixed(2);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
            renderContent();
        });

        // å„²å­˜è³‡æ–™
        function saveData() {
            db.ref('/').set({
                itinerary: itineraryData,
                expenses: expenses,
                people: people,
                rate: exchangeRate
            }).then(() => {
                document.getElementById('syncStatus').className = 'sync-status online';
                document.getElementById('syncStatus').textContent = 'ğŸŸ¢ åŒæ­¥æˆåŠŸ';
            }).catch(() => {
                document.getElementById('syncStatus').className = 'sync-status offline';
                document.getElementById('syncStatus').textContent = 'ğŸ”´ åŒæ­¥å¤±æ•—';
            });
        }

        // åŒ¯ç‡
        function updateRate() {
            exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 22.50;
            saveData();
            renderContent();
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                exchangeRate = data.rates.TWD;
                document.getElementById('exchangeRate').value = exchangeRate.toFixed(2);
                saveData();
                renderContent();
            } catch (e) {}
        }

        // åˆ‡æ›é é¢
        function showPage(page) {
            currentPage = page;
            document.getElementById('itinerary-view').classList.toggle('hidden', page !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', page !== 'split');
            document.getElementById('itinerary-actions').classList.toggle('hidden', page !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', page !== 'split');
            document.getElementById('itinerary-tab').classList.toggle('tab-active', page === 'itinerary');
            document.getElementById('itinerary-tab').classList.toggle('tab-inactive', page !== 'itinerary');
            document.getElementById('split-tab').classList.toggle('tab-active', page === 'split');
            document.getElementById('split-tab').classList.toggle('tab-inactive', page !== 'itinerary');
            renderContent();
        }

        // æ¸²æŸ“å…§å®¹
        function renderContent() {
            if (currentPage === 'itinerary') renderTable();
            else renderSplitView();
        }

        // è¡Œç¨‹æ¸²æŸ“
        function renderTable() {
            const tbody = document.getElementById('itineraryBody');
            tbody.innerHTML = itineraryData.map((item, index) => `
                <tr draggable="true" 
                    ondragstart="handleDragStart(${index}, event)" 
                    ondragover="handleDragOver(event)" 
                    ondrop="handleDrop(${index}, event)" 
                    ondragenter="handleDragEnter(event)" 
                    ondragleave="handleDragLeave(event)" 
                    class="hover:bg-gray-50 transition-colors">
                    <td class="table-cell w-20 sm:w-24">
                        <div class="datetime-cell">
                            <div contenteditable onblur="updateDatetime(${index}, 'day', this.textContent)">${item.day}</div>
                            <div contenteditable onblur="updateDatetime(${index}, 'time', this.textContent)">${item.time}</div>
                        </div>
                    </td>
                    <td class="table-cell w-32 sm:w-48" contenteditable onblur="updateItinerary(${index}, 'location', this.textContent)">${item.location}</td>
                    <td class="table-cell w-24 sm:w-32" contenteditable onblur="updateItinerary(${index}, 'travelTime', this.textContent)">${item.travelTime || ''}</td>
                    <td class="table-cell w-20 sm:w-28">
                        <a href="${item.mapLink || '#'}" target="_blank" class="text-blue-500">${item.mapLink ? 'ğŸ—ºï¸' : 'ğŸ“'}</a>
                        <button onclick="editMapLink(${index})" class="text-sm ml-1 text-gray-500">âœï¸</button>
                    </td>
                    <td class="table-cell w-20 sm:w-32 text-right"><input type="number" value="${item.estimatedJpy || 0}" onblur="updateItinerary(${index}, 'estimatedJpy', this.value)" class="currency-input"></td>
                    <td class="table-cell w-32 sm:w-48" contenteditable onblur="updateItinerary(${index}, 'notes', this.textContent)">${item.notes || ''}</td>
                    <td class="table-cell w-12 sm:w-16 text-center"><button onclick="deleteRow(${index})" class="text-red-500">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
            calculateTotals();
        }

        function handleDragStart(index, e) {
            draggedIndex = index;
            e.target.classList.add('bg-gray-200');
        }

        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { e.target.closest('tr')?.classList.add('bg-gray-100'); }
        function handleDragLeave(e) { e.target.closest('tr')?.classList.remove('bg-gray-100'); }
        function handleDrop(index, e) {
            e.preventDefault();
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('bg-gray-200', 'bg-gray-100'));
            if (draggedIndex !== index) {
                const [item] = itineraryData.splice(draggedIndex, 1);
                itineraryData.splice(index, 0, item);
                saveData();
                renderTable();
            }
        }

        function editMapLink(index) {
            const row = document.querySelector(`#itineraryBody tr:nth-child(${index + 1}) td:nth-child(4)`);
            const input = document.createElement('input');
            input.type = 'url';
            input.value = itineraryData[index].mapLink || '';
            input.className = 'currency-input w-full';
            input.onblur = () => {
                itineraryData[index].mapLink = input.value;
                saveData();
                renderTable();
            };
            row.innerHTML = '';
            row.appendChild(input);
            input.focus();
        }

        function updateDatetime(index, key, value) {
            const parsed = parseInt(value) || (key === 'day' ? 1 : '00:00');
            itineraryData[index][key] = parsed;
            saveData();
        }

        function updateItinerary(index, key, value) {
            const parsed = key.includes('Jpy') ? parseInt(value) || 0 : value;
            itineraryData[index][key] = parsed;
            saveData();
        }

        function addRow() {
            const lastDay = itineraryData.length ? Math.max(...itineraryData.map(i => i.day)) : 1;
            itineraryData.push({ day: lastDay, time: '', location: '', travelTime: '', mapLink: '', estimatedJpy: 0, notes: '' });
            saveData();
            renderTable();
        }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                itineraryData.splice(index, 1);
                saveData();
                renderTable();
            }
        }

        function calculateTotals() {
            const totalEst = itineraryData.reduce((sum, i) => sum + (i.estimatedJpy || 0), 0);
            document.getElementById('totalEstimatedJpy').textContent = `${totalEst.toLocaleString()} JPY`;
        }

        // åˆ†å¸³æ¸²æŸ“
        function renderSplitView() {
            const filtered = currentFilter ? expenses.filter(e => e.category === currentFilter) : expenses;
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = filtered.map(e => `
                <tr>
                    <td class="table-cell" contenteditable onblur="updateExpense(${e.id}, 'description', this.textContent)">${e.description}</td>
                    <td class="table-cell text-right"><input type="number" value="${e.amount}" onblur="updateExpense(${e.id}, 'amount', this.value)" class="currency-input"></td>
                    <td class="table-cell">
                        <select onchange="updateExpense(${e.id}, 'currency', this.value)" class="w-full p-1 border rounded text-xs sm:text-sm">
                            <option ${e.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                            <option ${e.currency === 'TWD' ? 'selected' : ''}>TWD</option>
                        </select>
                    </td>
                    <td class="table-cell">
                        <select onchange="updateExpense(${e.id}, 'payer', this.value)" class="w-full p-1 border rounded text-xs sm:text-sm">
                            ${people.map(p => `<option ${e.payer === p ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </td>
                    <td class="table-cell text-right text-green-600">${Math.round(calculateTwd(e.amount, e.currency)).toLocaleString()} TWD</td>
                    <td class="table-cell text-center"><button onclick="deleteExpense(${e.id})" class="text-red-500">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
            renderSettlement();
        }

        function updateExpense(id, key, value) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense[key] = key === 'amount' ? parseFloat(value) || 0 : value;
                if (key === 'description') expense.category = categorizeExpense(value);
                saveData();
                renderSplitView();
            }
        }

        function calculateTwd(amount, currency) {
            return currency === 'JPY' ? Math.round(amount * exchangeRate) : Math.round(amount);
        }

        function categorizeExpense(desc) {
            const map = { äº¤é€š: ['å·´å£«', 'JR'], é¤é£²: ['é¤', 'é£¯'], é–€ç¥¨: ['ç¥¨'], ä½å®¿: ['æ©Ÿç¥¨', 'é£¯åº—'], è³¼ç‰©: ['è²·'] };
            return Object.entries(map).find(([k, v]) => v.some(w => desc.includes(w)))?.[0] || '';
        }

        function filterExpenses() {
            currentFilter = document.getElementById('categoryFilter').value;
            renderSplitView();
        }

        function deleteExpense(id) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                renderSplitView();
            }
        }

        function addExpense() {
            expenses.push({ id: Date.now(), description: '', amount: 0, currency: 'JPY', payer: people[0] });
            saveData();
            renderSplitView();
        }

        function editPeople() {
            const names = prompt('è¼¸å…¥6äººå§“å (é€—è™Ÿåˆ†éš”):', people.join(','));
            if (names) {
                const newPeople = names.split(',').map(n => n.trim()).filter(Boolean);
                if (newPeople.length === 6) {
                    people = newPeople;
                    saveData();
                    renderSplitView();
                } else alert('è«‹è¼¸å…¥æ­£å¥½6å€‹å§“åï¼');
            }
        }

        function renderSettlement() {
            const total = expenses.reduce((sum, e) => sum + calculateTwd(e.amount, e.currency), 0);
            const perPerson = total / people.length;
            const balance = {};
            people.forEach(p => balance[p] = 0);
            expenses.forEach(e => balance[e.payer] += calculateTwd(e.amount, e.currency));

            const settlement = document.getElementById('settlement');
            settlement.innerHTML = `
                <div class="bg-blue-100 p-2 sm:p-3 rounded-lg mb-1 sm:mb-2">
                    <p class="text-xs sm:text-sm">ç¸½æ”¯å‡º: <strong>${total.toLocaleString()} TWD</strong></p>
                </div>
                <div class="bg-green-100 p-2 sm:p-3 rounded-lg mb-1 sm:mb-2">
                    <p class="text-xs sm:text-sm">æ¯äººæ‡‰ä»˜: <strong>${Math.round(perPerson).toLocaleString()} TWD</strong></p>
                </div>
                <div class="bg-purple-100 p-2 sm:p-3 rounded-lg">
                    ${people.map(p => `
                        <p class="text-xs sm:text-sm">${p}: <strong class="${balance[p] > perPerson ? 'text-green-600' : 'text-red-600'}">
                            ${Math.round(balance[p] - perPerson)} TWD</strong></p>
                    `).join('')}
                </div>
            `;
        }

        // åˆå§‹åŒ–
        window.onload = () => showPage('itinerary');
    </script>
</body>
</html>

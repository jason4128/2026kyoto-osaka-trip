<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½å¤§é˜ªæ—…éŠè¡Œç¨‹åŠåˆ†å¸³ç³»çµ± - å¤šäººå”ä½œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        [contenteditable]:focus {
            outline: 2px solid #3b82f6;
            background-color: #eef2ff;
        }
        .table-cell { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; }
        .header-cell {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white; position: sticky; top: 0; z-index: 10;
        }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { background-color: white; color: #1d4ed8; border-top: 3px solid #1d4ed8; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-bottom: 1px solid white; }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; }
        .currency-input-container {
            display: flex; justify-content: flex-end; align-items: center; padding: 4px 8px; 
            border: 1px solid #d1d5db; border-radius: 6px; background-color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .currency-input-container:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.5); }
        .currency-input { appearance: none; width: 8rem; text-align: right; padding: 0; border: none; outline: none; background: transparent; }
        .currency-input::-webkit-outer-spin-button, .currency-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .smooth-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sync-status { font-size: 0.75rem; }
        .online { color: #10b981; }
        .offline { color: #ef4444; }
        
        /* é‡å°æ—¥æœŸ/æ™‚é–“è¼¸å…¥æ¡†çš„æ¨£å¼èª¿æ•´ */
        .date-time-input {
            position: relative; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .date-time-input input[type="time"] {
            border: none !important;
            padding: 2px 0 !important;
            height: auto !important;
            line-height: 1.2 !important;
            font-size: 13px !important;
            color: #4b5563;
            background: transparent !important;
            text-align: center;
        }

        /* æ¡Œé¢é è¨­å¯¬åº¦ */
        .w-datetime { width: 150px; min-width: 150px; } 
        .w-location { width: 250px; min-width: 250px; }
        /* èª¿æ•´ w-32 æ¬„ä½å¯¬åº¦ä»¥å®¹ç´è¤‡åˆè¼¸å…¥æ¡† */
        .w-32 { width: 150px; min-width: 150px; } 
        .w-28 { width: 112px; min-width: 112px; }
        .w-48 { width: 192px; min-width: 192px; }

        /* === æ‰‹æ©Ÿç‰ˆæ¬„å¯¬å„ªåŒ– (æ›´ç·Šæ¹Š) === */
        @media (max-width: 768px) {
            .table-cell { padding: 8px 4px !important; font-size: 12px; }
            .header-cell { font-size: 12px; padding: 8px 4px; }
            .p-6 { padding: 1rem; }
            .p-4 { padding: 0.75rem; }
            .overflow-x-auto { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
            #itineraryTable th, #itineraryTable td { min-width: 80px; word-break: break-word; }
            
            /* ä¸­å‹è£ç½® (å¹³æ¿/å¯¬æ‰‹æ©Ÿ) æ¬„å¯¬èª¿æ•´ */
            .w-datetime { width: 95px !important; min-width: 95px !important; } 
            .w-location { width: 150px !important; min-width: 150px !important; }
            .w-32 { width: 120px !important; min-width: 120px !important; } /* èª¿æ•´é ç®—æ¬„ä½å¯¬åº¦ */
            .w-28 { width: 60px !important; min-width: 60px !important; } 
            .w-48 { width: 130px !important; min-width: 130px !important; }
        }

        @media (max-width: 640px) {
            .table-cell { padding: 6px 2px !important; font-size: 11px !important; }
            #itineraryTable th { font-size: 10px !important; padding: 6px 2px !important; }
            .header-cell { padding: 6px 2px !important; font-size: 9px !important; }
            
            /* å°å‹è£ç½® (æ‰‹æ©Ÿ) æ¬„å¯¬èª¿æ•´ - æ¥µåº¦ç·Šæ¹Š */
            .w-datetime { width: 80px !important; min-width: 80px !important; } 
            .w-location { width: 120px !important; min-width: 120px !important; }
            .w-32 { width: 80px !important; min-width: 80px !important; } /* èª¿æ•´é ç®—æ¬„ä½å¯¬åº¦ */
            .w-28 { width: 45px !important; min-width: 45px !important; } 
            .w-48 { width: 90px !important; min-width: 90px !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <header class="p-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-xl">
            <h1 class="text-3xl font-bold text-white mb-2">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ª4å¤©3å¤œæ—…éŠè¦åŠƒ ğŸ¯</h1>
            <p class="text-blue-100 text-sm">âœ¨ è‡ªå‹•æŒ‰æ—¥æœŸæ™‚é–“æ’åº | âœï¸é»æ“Šç·¨è¼¯åœ°åœ– | å³æ™‚åˆ†å¸³è¨ˆç®—</p>
            <div class="flex items-center justify-between mt-2">
                <span id="syncStatus" class="sync-status online">ğŸŸ¢ å³æ™‚åŒæ­¥ä¸­</span>
                <span class="text-xs text-blue-100">æœ€å¾Œæ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">ğŸ“… è¡Œç¨‹è¡¨</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">ğŸ’° åˆ†å¸³è¡¨ (6äºº)</div>
        </div>

        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY åŒ¯ç‡:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView(); saveData()"
                           title="å³æ™‚åŒ¯ç‡ (ä¾‹å¦‚: 22.50)">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ğŸ”„ æ›´æ–°</button>
            </div>

            <div id="itinerary-actions" class="flex items-center space-x-3">
                <label for="dateFilter" class="text-sm font-medium text-gray-700">ç¯©é¸æ—¥æœŸ:</label>
                <select id="dateFilter" class="p-2 border rounded-md shadow-sm bg-white text-sm" onchange="applyDateFilter(this.value)">
                    </select>
                <button onclick="addRow(); saveData()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ æ–°å¢è¡Œç¨‹</button>
            </div>
            
            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense(); saveData()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ ç™»è¼‰æ”¯å‡º</button>
                <button onclick="togglePersonEditModal(); saveData()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">ğŸ‘¤ ç·¨è¼¯äººå</button>
            </div>
        </div>

        <div id="itinerary-view" class="p-4 sm:p-6">
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-datetime">æ—¥æœŸ/æ™‚é–“</th>
                            <th class="header-cell w-location">åœ°é»</th>
                            <th class="header-cell w-32">äº¤é€š</th>
                            <th class="header-cell w-28">åœ°åœ–</th>
                            <th class="header-cell w-32 text-right">ğŸ’° é ç®—</th>
                            <th class="header-cell w-48 rounded-tr-xl">å‚™è¨»</th>
                            <th class="header-cell w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    <tfoot>
                        <tr class="bg-gradient-to-r from-blue-50 to-purple-50 text-base font-bold text-gray-800">
                            <td colspan="4" class="table-cell text-right py-4">ç¸½è¨ˆ:</td>
                            <td id="totalEstimated" class="table-cell text-right py-4 text-red-600">0 JPY</td>
                            <td colspan="2" class="table-cell py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ’µ æ”¯å‡ºç™»è¼‰è¡¨</h2>
            <div class="flex gap-2 mb-4">
                <select id="categoryFilter" class="p-2 border rounded w-full sm:w-auto" onchange="filterExpenses()">
                    <option value="">æ‰€æœ‰é¡åˆ¥</option>
                    <option value="äº¤é€š">äº¤é€š</option>
                    <option value="é¤é£²">é¤é£²</option>
                    <option value="é–€ç¥¨">é–€ç¥¨</option>
                    <option value="ä½å®¿">ä½å®¿</option>
                    <option value="è³¼ç‰©">è³¼ç‰©</option>
                </select>
            </div>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">é …ç›®åç¨±</th>
                            <th class="p-3 w-40 text-right">é‡‘é¡</th>
                            <th class="p-3 w-28">å¹£åˆ¥</th>
                            <th class="p-3 w-32">ä»˜æ¬¾äºº</th>
                            <th class="p-3 w-40 text-right">å°å¹£é‡‘é¡</th>
                            <th class="p-3 w-16">ğŸ—‘ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">âš–ï¸ å³æ™‚çµç®—çµæœ</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ”„ è½‰å¸³æ¸…å–® (èª°è©²ä»˜èª°)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-yellow-50 text-gray-800"></div>
        </div>
    </div>

    <script>
        // === Firebase é…ç½® (è«‹æ›¿æ›ç‚ºæ‚¨çš„çœŸå¯¦é‡‘é‘°) ===
        const firebaseConfig = {
            apiKey: "AIzaSyxxxxxxxxxxxxxxxxxxxx",  
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.appBucket.com",
            messagingSenderId: "xxxxxxxxxxx",  
            appId: "1:xxxxxxxxxxx:web:xxxxxxxxxxxxxxxx"  
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // === å…¨åŸŸè®Šæ•¸ ===
        let EXCHANGE_RATE = 22.50;
        const DEFAULT_PEOPLE = ['Aå›', 'Bå›', 'Cå›', 'Då›', 'Eå›', 'Få›'];
        let PEOPLE = DEFAULT_PEOPLE;
        
        let itineraryData = [];
        let expenses = [];
        let currentPage = 'itinerary';
        let currentFilterDate = 'all'; // é è¨­é¡¯ç¤ºå…¨éƒ¨

        // === å³æ™‚ç›£è½è³‡æ–™ ===
        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            itineraryData = data.itinerary || [];
            expenses = data.expenses || [];
            PEOPLE = data.people || DEFAULT_PEOPLE;
            EXCHANGE_RATE = data.rate || 22.50;
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
            
            if (currentPage === 'itinerary') renderTable();
            if (currentPage === 'split') renderSplitView();
            
            calculateTotals();
            calculateAndRenderSettlement();
        });

        // === å„²å­˜è³‡æ–™ ===
        function saveData() {
            db.ref('/').set({
                itinerary: itineraryData,
                expenses: expenses,
                people: PEOPLE,
                rate: EXCHANGE_RATE
            }).then(() => {
                document.getElementById('syncStatus').className = 'sync-status online';
                document.getElementById('syncStatus').textContent = 'ğŸŸ¢ åŒæ­¥æˆåŠŸ';
            }).catch(() => {
                document.getElementById('syncStatus').className = 'sync-status offline';
                document.getElementById('syncStatus').textContent = 'ğŸ”´ åŒæ­¥å¤±æ•—';
            });
        }

        // === è¼”åŠ©å‡½æ•¸ (æ–°å¢æ›ç®—é‚è¼¯) ===

        /**
         * è½‰æ›å¹£åˆ¥
         * @param {number} amount åŸå§‹é‡‘é¡
         * @param {string} fromCurrency åŸå§‹å¹£åˆ¥ ('JPY' or 'TWD')
         * @param {string} toCurrency ç›®æ¨™å¹£åˆ¥ ('JPY' or 'TWD')
         * @returns {number} è½‰æ›å¾Œçš„é‡‘é¡ (å››æ¨äº”å…¥åˆ°æ•´æ•¸)
         */
        function convertCurrency(amount, fromCurrency, toCurrency) {
            const num = parseFloat(amount) || 0;
            if (fromCurrency === toCurrency) return Math.round(num);

            if (fromCurrency === 'JPY' && toCurrency === 'TWD') {
                return Math.round(num * EXCHANGE_RATE);
            }
            if (fromCurrency === 'TWD' && toCurrency === 'JPY') {
                return EXCHANGE_RATE > 0 ? Math.round(num / EXCHANGE_RATE) : 0; 
            }
            return Math.round(num);
        }

        function updateExchangeRate(rate) {
            EXCHANGE_RATE = rate;
            document.getElementById('exchangeRate').value = rate.toFixed(2);
        }

        async function fetchExchangeRate() {
            try {
                // æ­¤ç‚ºç¯„ä¾‹ APIï¼Œå¯èƒ½éœ€æ›¿æ›ç‚ºå¯ç”¨ API
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); 
                const data = await response.json();
                updateExchangeRate(data.rates.TWD);
                saveData();
                calculateTotals();
                renderSplitView();
            } catch (e) {
                console.error("ç„¡æ³•ç²å–å³æ™‚åŒ¯ç‡", e);
            }
        }

        function showPage(pageName) {
            currentPage = pageName;
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            if (pageName === 'split') renderSplitView();
            if (pageName === 'itinerary') renderTable();
        }

        /**
         * å°‡ YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸå­—ä¸²è½‰æ›ç‚º MM/DD æ ¼å¼
         * @param {string} dateStr YYYY-MM-DD
         * @returns {string} MM/DD
         */
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 10) return '--/--';
            const parts = dateStr.split('-'); // [YYYY, MM, DD]
            return `${parts[1]}/${parts[2]}`; // MM/DD
        }

        // === æ—¥æœŸç¯©é¸å™¨åŠŸèƒ½ (ä¿æŒä¸è®Š) ===
        function populateDateFilter() {
            const select = document.getElementById('dateFilter');
            
            // æ‰¾å‡ºæ‰€æœ‰å”¯ä¸€çš„æ—¥æœŸ (æ’é™¤ç©ºå€¼)ï¼Œä¸¦æŒ‰æ—¥æœŸæ’åº
            const uniqueDates = [...new Set(itineraryData.map(item => item.day).filter(d => d && d.length === 10))].sort();
            
            let html = '<option value="all">å…¨éƒ¨æ—¥æœŸ</option>';
            
            uniqueDates.forEach(date => {
                const isSelected = date === currentFilterDate ? 'selected' : '';
                html += `<option value="${date}" ${isSelected}>${formatDate(date)}</option>`;
            });

            select.innerHTML = html;
        }

        function applyDateFilter(date) {
            currentFilterDate = date;
            renderTable();
        }

        // === è¡Œç¨‹è¡¨åŠŸèƒ½ (æ›´æ–°æ¸²æŸ“é‚è¼¯) ===
        function renderTable() {
            const tbody = document.getElementById('itineraryBody');
            tbody.innerHTML = '';
            
            // 1. åŸ·è¡Œæ—¥æœŸ+æ™‚é–“çš„è‡ªå‹•æ’åº (YYYY-MM-DDHH:MM)
            itineraryData.sort((a, b) => {
                const dateTimeA = (a.day || '9999-12-31') + (a.time || '23:59');
                const dateTimeB = (b.day || '9999-12-31') + (b.time || '23:59');
                if (dateTimeA < dateTimeB) return -1;
                if (dateTimeA > dateTimeB) return 1;
                return 0;
            });

            // 2. éæ¿¾æ•¸æ“šï¼ŒåŒæ™‚ä¿ç•™åŸå§‹ç´¢å¼•
            let filteredData = itineraryData.map((item, originalIndex) => ({ ...item, originalIndex })).filter(item => {
                return currentFilterDate === 'all' || item.day === currentFilterDate;
            });

            // 3. æ¸²æŸ“éæ¿¾å¾Œçš„æ•¸æ“š
            filteredData.forEach((item) => {
                // ä½¿ç”¨ originalIndex ç¢ºä¿ CRUD (ç·¨è¼¯/åˆªé™¤) æ“ä½œæŒ‡å‘æ­£ç¢ºçš„åŸå§‹æ•¸æ“š
                const dataIndex = item.originalIndex; 

                // è™•ç†èˆŠè³‡æ–™è½‰æ›ï¼Œç¢ºä¿æœ‰æ–°æ¬„ä½
                const amount = item.estimatedAmount !== undefined ? item.estimatedAmount : (item.estimatedJpy || 0);
                const currency = item.estimatedCurrency || 'JPY';

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 smooth-transition';

                const cells = [
                    { key: 'dateTime', editable: false, class: 'font-bold w-datetime' }, 
                    { key: 'location', editable: true, class: 'w-location' },
                    { key: 'travelTime', editable: true },
                    { key: 'mapLink', editable: false },
                    { key: 'budgetInput', editable: false, budget: true, class: 'w-32 text-red-500 text-right' },
                    { key: 'notes', editable: true }
                ];

                cells.forEach(field => {
                    const cell = row.insertCell();
                    cell.className = `table-cell ${field.class || ''}`;
                    
                    if (field.key === 'mapLink') {
                        const url = item.mapLink || '';
                        const text = url && url !== 'https://maps.google.com' ? 'ğŸ—ºï¸ æŸ¥çœ‹' : 'ğŸ“ è¨­å®š';
                        cell.innerHTML = `
                            <div class="flex items-center space-x-2"> 
                                <a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-700 ${url ? '' : 'text-gray-400 italic'}">${text}</a>
                                <button onclick="startMapLinkEdit(${dataIndex})" class="p-1 hover:bg-blue-100 rounded-full">âœï¸</button>
                            </div>
                        `;
                    } 
                    // === é ç®—è¼¸å…¥æ¬„ä½ (æ–°å¢) ===
                    else if (field.key === 'budgetInput') {
                        const converted = convertCurrency(amount, currency, currency === 'JPY' ? 'TWD' : 'JPY');
                        const convertedUnit = currency === 'JPY' ? 'TWD' : 'JPY';
                        
                        cell.className = 'table-cell w-32 text-right p-1';
                        cell.innerHTML = `
                            <div class="flex flex-col items-end space-y-0.5">
                                <div class="flex items-center border rounded-md p-1 shadow-sm bg-white focus-within:ring-2 focus-within:ring-blue-500 w-full">
                                    <input type="number" 
                                           value="${amount}" 
                                           min="0"
                                           class="w-full text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent text-sm"
                                           oninput="handleBudgetInput(${dataIndex}, this.value, '${currency}')"
                                           onblur="finalizeBudgetUpdate(${dataIndex}, this.value)">
                                    <select onchange="handleCurrencyChange(${dataIndex}, this.value)" class="text-xs font-bold border-l pl-1 bg-transparent pr-0 ml-1 h-full cursor-pointer">
                                        <option value="JPY" ${currency === 'JPY' ? 'selected' : ''}>JPY</option>
                                        <option value="TWD" ${currency === 'TWD' ? 'selected' : ''}>TWD</option>
                                    </select>
                                </div>
                                <span class="text-xs text-gray-500 mt-0.5" id="converted-${dataIndex}">
                                    ç´„ ${converted.toLocaleString()} ${convertedUnit}
                                </span>
                            </div>
                        `;
                    }
                    // === æ—¥æœŸ/æ™‚é–“æ¬„ä½ (ä¿æŒä¸è®Š) ===
                    else if (field.key === 'dateTime') {
                        const dateValue = item.day || new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                        const timeValue = item.time || '09:30';
                        
                        cell.className = 'table-cell font-bold p-1'; 
                        cell.innerHTML = `
                            <div class="flex flex-col space-y-0.5 text-center items-center date-time-input">
                                <span class="text-sm font-bold text-gray-800 hover:bg-blue-50 rounded px-1">${formatDate(dateValue)}</span>
                                <input type="date" value="${dateValue}" 
                                       class="absolute top-0 left-0 w-full h-1/2 opacity-0 cursor-pointer"
                                       onchange="handleDateInput(${dataIndex}, this.value)">
                                <input type="time" value="${timeValue}" 
                                       class="w-full text-center focus:outline-none focus:ring-0 text-sm"
                                       onchange="handleCellEdit(${dataIndex}, 'time', this.value, false)">
                            </div>
                        `;
                    }
                    else {
                        let content = item[field.key] || '';
                        cell.textContent = content;
                        
                        if (field.editable) {
                            cell.contentEditable = true;
                            // å‚™è¨»/åœ°é»/äº¤é€šæ™‚é–“ä½¿ç”¨èˆŠçš„ç·¨è¼¯é‚è¼¯
                            cell.onblur = (e) => handleCellEdit(dataIndex, field.key, e.target.innerText, false); 
                        }
                    }
                });

                const delCell = row.insertCell();
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteRow(${dataIndex})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
            
            // 4. æ›´æ–°ç¯©é¸å™¨å’Œç¸½è¨ˆ
            populateDateFilter(); 
            calculateTotals();
        }
        
        // === è³‡æ–™æ“ä½œå‡½æ•¸ (æ–°å¢é ç®—è™•ç†) ===

        function handleBudgetInput(index, value, currentCurrency) {
            // å³æ™‚æ›´æ–°è½‰æ›é‡‘é¡é¡¯ç¤º (ä¸å­˜æª”)
            const num = parseFloat(value) || 0;
            const targetCurrency = currentCurrency === 'JPY' ? 'TWD' : 'JPY';
            const converted = convertCurrency(num, currentCurrency, targetCurrency);
            
            const convertedSpan = document.getElementById(`converted-${index}`);
            if (convertedSpan) {
                convertedSpan.textContent = `ç´„ ${converted.toLocaleString()} ${convertedUnit}`;
            }
        }
        
        function finalizeBudgetUpdate(index, value) {
            // å¤±å»ç„¦é»æ™‚å„²å­˜æ•¸æ“šä¸¦æ›´æ–°ç¸½è¨ˆ
            const num = parseInt(value) || 0;
            // å¿…é ˆåŒæ™‚è™•ç†èˆŠè³‡æ–™çš„çµæ§‹
            itineraryData[index].estimatedAmount = num; 
            if (itineraryData[index].estimatedJpy !== undefined) {
                 delete itineraryData[index].estimatedJpy;
            }
            saveData(); 
            calculateTotals();
        }

        function handleCurrencyChange(index, newCurrency) {
            const item = itineraryData[index];
            item.estimatedCurrency = newCurrency;
            
            // ç”±æ–¼å¹£åˆ¥æ”¹è®Šï¼Œéœ€è¦é‡æ–°è¨ˆç®—å³æ™‚è½‰æ›å€¼
            handleBudgetInput(index, item.estimatedAmount || 0, newCurrency); 
            
            saveData();
            calculateTotals(); 
        }

        // åœ°é»/äº¤é€š/å‚™è¨»ç·¨è¼¯ (éé ç®—æ¬„ä½)
        function handleCellEdit(index, key, value, isBudget) {
            // isBudget ç¾åœ¨æ°¸é ç‚º false
            let parsed = value.trim(); 
            itineraryData[index][key] = parsed;
            saveData();
            
            if (key === 'time') {
                renderTable(); 
            }
        }
        
        function handleDateInput(index, dateValue) {
            itineraryData[index]['day'] = dateValue; 
            saveData();
            renderTable();
        }

        function startMapLinkEdit(index) {
            const currentLink = itineraryData[index].mapLink || '';
            const newLink = prompt('è²¼ä¸ŠGoogleåœ°åœ–é€£çµ:', currentLink);
            
            if (newLink !== null) {
                itineraryData[index].mapLink = newLink.trim();
                saveData();
                renderTable();
            }
        }

        function addRow() {
            const defaultDate = itineraryData.length 
                ? itineraryData[itineraryData.length - 1].day || new Date().toISOString().split('T')[0]
                : new Date().toISOString().split('T')[0];

            itineraryData.push({
                day: defaultDate, 
                time: "09:30", 
                location: "æ–°å¢åœ°é»", 
                travelTime: "", 
                mapLink: "", 
                estimatedAmount: 0, // æ–°å¢ï¼šé‡‘é¡
                estimatedCurrency: 'JPY', // æ–°å¢ï¼šå¹£åˆ¥
                notes: ""
            });
            saveData();
            renderTable();
        }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                itineraryData.splice(index, 1);
                saveData();
                renderTable();
            }
        }
        
        // === ç¸½è¨ˆè¨ˆç®— (æ›´æ–°é‚è¼¯) ===
        function calculateTotals() {
            const dataToSum = currentFilterDate === 'all' 
                ? itineraryData
                : itineraryData.filter(item => item.day === currentFilterDate);

            // 1. å°‡æ‰€æœ‰é‡‘é¡çµ±ä¸€è½‰æ›ç‚º JPY é€²è¡Œç¸½å’Œ
            const totalEstJpy = dataToSum.reduce((sum, i) => {
                // è™•ç†èˆŠè³‡æ–™çµæ§‹ (å¦‚æœåªå­˜ estimatedJpy)
                const amount = i.estimatedAmount !== undefined ? (i.estimatedAmount || 0) : (i.estimatedJpy || 0);
                const currency = i.estimatedCurrency || (i.estimatedJpy !== undefined ? 'JPY' : 'JPY');
                
                return sum + convertCurrency(amount, currency, 'JPY');
            }, 0);
            
            // 2. æ ¹æ“š JPY ç¸½å’Œè¨ˆç®— TWD ç¸½å’Œ
            const totalEstTwd = convertCurrency(totalEstJpy, 'JPY', 'TWD');
            
            // ç¸½è¨ˆæ–‡å­—èª¿æ•´ä»¥åæ˜ ç¯©é¸ç‹€æ…‹
            const prefix = currentFilterDate === 'all' ? 'ç¸½è¨ˆ' : `${formatDate(currentFilterDate)} ç¸½è¨ˆ`;
            document.querySelector('#itineraryTable tfoot tr td:first-child').textContent = `${prefix}:`;
            
            // æ›´æ–°ç¸½è¨ˆæ¬„ä½ï¼ŒåŒæ™‚é¡¯ç¤º JPY å’Œ TWD
            document.getElementById('totalEstimated').innerHTML = `
                <div class="flex flex-col items-end">
                    <span class="text-base font-bold text-red-600">${totalEstJpy.toLocaleString()} JPY</span>
                    <span class="text-sm font-semibold text-gray-700">(${totalEstTwd.toLocaleString()} TWD)</span>
                </div>
            `;
        }
        
        // (åˆ†å¸³åŠŸèƒ½ç›¸é—œå‡½æ•¸ä¿æŒä¸è®Š)
        let updateTimeout = null;

        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
                const row = tbody.insertRow();
                row.id = `expense-${expense.id}`;
                
                const descCell = row.insertCell();
                descCell.className = 'table-cell';
                descCell.innerHTML = `<span contenteditable="true" onblur="updateExpenseField(${expense.id}, 'description', this.textContent)">${expense.description}</span>`;
                
                const amountCell = row.insertCell();
                amountCell.className = 'table-cell text-right p-2';
                amountCell.innerHTML = `
                    <div class="currency-input-container">
                        <input type="number" 
                               value="${expense.amount}" 
                               min="0" 
                               class="currency-input"
                               oninput="handleAmountInput(${expense.id}, this.value)"
                               onblur="finalizeAmountUpdate(${expense.id}, this.value)"
                               placeholder="0">
                    </div>
                `;
                
                const currencyCell = row.insertCell();
                currencyCell.className = 'table-cell';
                currencyCell.innerHTML = createCurrencySelect(expense.id, expense.currency);
                
                const payerCell = row.insertCell();
                payerCell.className = 'table-cell';
                payerCell.innerHTML = createPayerSelect(expense.id, expense.payer);
                
                const twdCell = row.insertCell();
                twdCell.className = 'table-cell text-right font-mono text-green-600';
                twdCell.id = `twd-${expense.id}`;
                twdCell.textContent = `${calculateTwdEquivalent(expense.amount, expense.currency).toLocaleString()} TWD`;
                
                const delCell = row.insertCell();
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteExpense(${expense.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">ğŸ—‘ï¸</button>`;
            });
            
            setTimeout(() => calculateAndRenderSettlement(), 100);
        }

        function handleAmountInput(id, value) {
            clearTimeout(updateTimeout);
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.amount = parseFloat(value) || 0;
                const twdCell = document.getElementById(`twd-${id}`);
                if (twdCell) {
                    twdCell.textContent = `${calculateTwdEquivalent(value, expense.currency).toLocaleString()} TWD`;
                }
            }
        }

        function finalizeAmountUpdate(id, value) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.amount = parseFloat(value) || 0;
                saveData();
                setTimeout(() => calculateAndRenderSettlement(), 200);
            }
        }

        function createCurrencySelect(id, current) {
            return `<select onchange="updateExpenseField(${id}, 'currency', this.value)" class="p-1 border rounded w-full">
                <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
            </select>`;
        }

        function createPayerSelect(id, current) {
            return `<select onchange="updateExpenseField(${id}, 'payer', this.value)" class="p-1 border rounded w-full">
                ${PEOPLE.map(p => `<option value="${p}" ${current === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>`;
        }

        function updateExpenseField(id, field, value) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense[field] = value;
                saveData();
                
                if (field === 'currency' || field === 'amount') {
                    const twdCell = document.getElementById(`twd-${id}`);
                    if (twdCell) {
                        twdCell.textContent = `${calculateTwdEquivalent(expense.amount, expense.currency).toLocaleString()} TWD`;
                    }
                }
                
                setTimeout(() => calculateAndRenderSettlement(), 200);
            }
        }

        // åˆ†å¸³å°ˆç”¨çš„ TWD æ›ç®—é‚è¼¯ (èˆ‡è¡Œç¨‹è¡¨çš„ convertCurrency é‚è¼¯ç›¸åŒ)
        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num * EXCHANGE_RATE) : Math.round(num);
        }

        function addExpense() {
            expenses.push({
                id: Date.now(), description: 'æ–°æ”¯å‡º', amount: 0, currency: 'JPY', payer: PEOPLE[0]
            });
            saveData();
            renderSplitView();
        }

        function deleteExpense(id) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                renderSplitView();
            }
        }

        function togglePersonEditModal() {
            const names = prompt('è¼¸å…¥6äººå§“å (é€—è™Ÿåˆ†éš”):', PEOPLE.join(','));
            if (names) {
                const newPeople = names.split(',').map(n => n.trim()).filter(Boolean);
                if (newPeople.length === 6) {
                    PEOPLE = newPeople;
                    saveData();
                    renderSplitView();
                } else alert('è«‹è¼¸å…¥æ­£å¥½6å€‹å§“åï¼');
            }
        }

        function calculateAndRenderSettlement() {
            const balance = {};
            PEOPLE.forEach(p => balance[p] = 0);
            let totalTWD = 0;
            
            expenses.forEach(e => {
                const twd = calculateTwdEquivalent(e.amount, e.currency);
                balance[e.payer] += twd;
                totalTWD += twd;
            });
            
            const sharePerPerson = totalTWD / PEOPLE.length;
            
            const netBalance = {};
            PEOPLE.forEach(person => {
                netBalance[person] = Math.round((balance[person] - sharePerPerson) * 100) / 100; 
            });
            
            const creditors = []; 
            const debtors = [];   
            
            PEOPLE.forEach(person => {
                const amount = Math.abs(Math.round(netBalance[person]));
                if (netBalance[person] > 0) {
                    creditors.push({ name: person, amount });
                } else if (netBalance[person] < 0 && amount > 0) {
                    debtors.push({ name: person, amount });
                }
            });
            
            let settlements = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const transfer = Math.min(debtors[i].amount, creditors[j].amount);
                if (transfer >= 1) {
                    settlements.push({
                        from: debtors[i].name,
                        to: creditors[j].name,
                        amount: transfer
                    });
                }
                debtors[i].amount -= transfer;
                creditors[j].amount -= transfer;
                
                if (debtors[i].amount < 1) i++;
                if (creditors[j].amount < 1) j++;
            }
            
            renderSettlementSummary(totalTWD, sharePerPerson, netBalance);
            renderSettlementList(settlements);
        }

        function renderSettlementSummary(totalTWD, sharePerPerson, netBalance) {
            document.getElementById('settlement-summary').innerHTML = `
                <div class="p-4 bg-blue-100 rounded-lg">
                    <p class="text-sm">ç¸½æ”¯å‡º</p>
                    <p class="text-2xl font-bold text-blue-900">${totalTWD.toLocaleString()} TWD</p>
                </div>
                <div class="p-4 bg-green-100 rounded-lg">
                    <p class="text-sm">æ¯äººæ‡‰ä»˜</p>
                    <p class="text-2xl font-bold text-green-900">${Math.round(sharePerPerson).toLocaleString()} TWD</p>
                </div>
                <div class="p-4 bg-purple-100 rounded-lg">
                    <p class="text-sm font-medium">å€‹äººçµé¤˜</p>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                        ${PEOPLE.map(person => {
                            const net = Math.round(netBalance[person]);
                            const color = net >= 0 ? 'text-green-700' : 'text-red-700';
                            const bg = net >= 0 ? 'bg-green-50' : 'bg-red-50';
                            return `<div class="p-1 rounded text-center ${bg}">
                                <strong>${person}</strong><br>
                                <span class="${color} font-bold">${net >= 0 ? '+' : ''}${net}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderSettlementList(settlements) {
            const listDiv = document.getElementById('settlement-list');
            
            if (settlements.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-green-600 font-bold py-4">âœ… å¸³ç›®å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</p>';
                listDiv.className = 'space-y-3 p-4 border rounded-lg bg-green-50 text-gray-800';
            } else {
                listDiv.innerHTML = settlements.map(s => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-md shadow border border-yellow-200">
                        <span class="font-medium">${s.from}</span>
                        <span class="text-gray-500 mx-2">â¡ï¸ è½‰</span>
                        <span class="font-medium">${s.to}</span>
                        <span class="ml-auto font-bold text-lg text-red-600">${s.amount.toLocaleString()} TWD</span>
                    </div>
                `).join('');
                listDiv.className = 'space-y-3 p-4 border rounded-lg bg-yellow-50 text-gray-800';
            }
        }

        function filterExpenses() {
            // å¾…å¯¦ä½œï¼šæ ¹æ“š categoryFilter é¸æ“‡çš„å€¼ä¾†éæ¿¾ expenses é™£åˆ—ä¸¦é‡æ–°æ¸²æŸ“è¡¨æ ¼
        }

        // === åˆå§‹åŒ– ===
        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
            renderTable();
        };
    </script>
</body>
</html>

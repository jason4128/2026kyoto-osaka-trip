<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🇯🇵 京都大阪旅遊規劃 🏯 - 禪意協作版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    
    <style>
        /* 🎨 基礎樣式和響應式調整 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #fffbeb; /* bg-amber-50 極淺米黃 */
            color: #333;
        }
        [contenteditable]:focus {
            outline: 2px solid #f472b6; /* 柔和玫瑰粉 */
            background-color: #fff7fa; /* 淺粉色背景 */
        }
        
        .table-cell { 
            padding: 12px; 
            border-bottom: 1px solid #e5e7eb; 
            vertical-align: top; 
            min-height: 48px; 
            line-height: 1.5;
        }
        
        .header-cell {
            background: linear-gradient(135deg, #fbcfe8, #f472b6); 
            color: #444; 
            position: sticky; top: 0; z-index: 10;
            padding: 12px;
        }
        .tab { cursor: pointer; padding: 10px 20px; font-weight: 600; transition: all 0.2s; border-radius: 8px 8px 0 0; margin-bottom: -1px; }
        .tab-active { 
            background-color: white; 
            color: #be185d; 
            border-top: 3px solid #be185d; 
            border-left: 1px solid #e5e7eb; 
            border-right: 1px solid #e5e7eb; 
            border-bottom: 1px solid white; 
        }
        .tab-inactive { background-color: #f3f4f6; color: #78716c; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; } 
        
        /* Flatpickr 樣式調整 */
        /* 隱藏 flatpickr 創建的真實輸入框，只顯示 altInput */
        .flatpickr-input[data-input] {
            opacity: 0;
            position: absolute;
            pointer-events: none;
            z-index: -1; /* 確保它不會覆蓋 altInput */
        }
        
        .flatpickr-input {
            border: none !important;
            padding: 0 !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
            cursor: pointer;
            width: 100%;
        }
        
        .date-time-container {
            position: relative;
        }
        
        /* 響應式調整 */
        .w-16 { min-width: 64px; }
        .w-20 { min-width: 80px; }
        .w-32 { min-width: 128px; }
        .w-48 { min-width: 192px; }
        .w-28 { min-width: 112px; }

        @media (max-width: 768px) {
            .table-cell { padding: 8px 4px !important; font-size: 12px; }
            .header-cell { font-size: 12px; padding: 8px 4px; }
            .overflow-x-auto { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 640px) {
            .table-cell { padding: 6px 2px !important; font-size: 11px !important; min-width: 60px !important; }
            #itineraryTable th { font-size: 10px !important; padding: 8px 2px !important; }
            .header-cell { padding: 6px 2px !important; font-size: 9px !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <header class="p-6 bg-gradient-to-r from-pink-100 to-yellow-50 rounded-t-xl border-b border-rose-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🇯🇵 京都大阪4天3夜旅遊規劃 🏯</h1>
            <p class="text-rose-600 text-sm">✨ 自動排序行程 | 📅 日曆式日期選擇 | 即時分帳計算</p>
            <div class="flex items-center justify-between mt-2">
                <span id="syncStatus" class="sync-status text-green-600 text-xs font-semibold">🟢 即時同步中</span>
                <span class="text-xs text-rose-500">最後更新: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <div class="flex border-b border-gray-200 px-6 pt-2 bg-gray-50">
            <div id="itinerary-tab" class="tab tab-active" onclick="showPage('itinerary')">📅 行程表</div>
            <div id="wishlist-tab" class="tab tab-inactive ml-2" onclick="showPage('wishlist')">💡 待定清單</div>
            <div id="split-tab" class="tab tab-inactive ml-2" onclick="showPage('split')">💰 分帳表 (6人)</div>
        </div>

        <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">TWD/JPY 匯率:</label>
                <div class="flex items-center border rounded-md shadow-sm bg-white p-2">
                    <span class="text-sm font-semibold text-gray-600">1 JPY = </span>
                    <input type="number" id="exchangeRate" value="22.50" step="0.01" min="0.01"
                           class="w-20 text-sm text-right font-semibold p-0 border-none focus:ring-0 focus:outline-none bg-transparent"
                           oninput="updateExchangeRate(parseFloat(this.value)); calculateTotals(); renderSplitView(); saveData()"
                           title="即時匯率 (例如: 22.50)">
                    <span class="text-sm text-gray-600"> TWD</span>
                </div>
                <button onclick="fetchExchangeRate()" class="bg-rose-300 text-gray-800 px-3 py-1 rounded text-sm hover:bg-rose-400 transition duration-200">🔄 更新</button>
            </div>
            
            <div id="itinerary-actions" class="">
                <button onclick="addRow(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ 新增行程</button>
            </div>
            
            <div id="wishlist-actions" class="hidden">
                <button onclick="addWishlistItem(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 text-sm">+ 新增想法</button>
            </div>
            
            <div id="split-actions" class="hidden flex space-x-2">
                <button onclick="addExpense(); saveData()" class="bg-rose-400 hover:bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow text-sm">+ 登載支出</button>
                <button onclick="togglePersonEditModal(); saveData()" class="bg-rose-300 hover:bg-rose-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow text-sm">👤 編輯人名</button>
            </div>
        </div>

        <div id="itinerary-view" class="p-4 sm:p-6">
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center space-x-2">
                    <label for="dayFilter" class="text-sm font-medium text-gray-700">顯示日期:</label>
                    <select id="dayFilter" onchange="filterItinerary(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm w-48 bg-white">
                        <option value="all">所有日期</option>
                        </select>
                </div>
                <div class="flex gap-4 text-sm font-bold text-gray-800">
                    <div class="bg-pink-100 p-2 rounded-md">總計 (JPY): <span id="totalEstimatedJpy" class="text-red-600">0 JPY</span></div>
                    <div class="bg-pink-100 p-2 rounded-md">總計 (TWD): <span id="totalEstimatedTwd" class="text-red-800">0 TWD</span></div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="itineraryTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider">
                            <th class="header-cell rounded-tl-xl w-28">日期/時間</th> 
                            <th class="header-cell w-48">地點</th>
                            <th class="header-cell w-32">交通</th>
                            <th class="header-cell w-28">地圖</th>
                            <th class="header-cell w-32 text-right">💰 預算</th> 
                            <th class="header-cell w-48 rounded-tr-xl">備註</th>
                            <th class="header-cell w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="itineraryBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    <tfoot>
                        <tr class="bg-gradient-to-r from-pink-50 to-amber-50 text-base font-bold text-gray-800">
                            <td colspan="4" class="table-cell text-right py-4">所選日期總計:</td> 
                            <td class="table-cell py-4 text-sm">
                                <div class="text-red-600 mb-1" id="filteredTotalJpy">0 JPY</div>
                                <div class="text-red-800" id="filteredTotalTwd">0 TWD</div>
                            </td>
                            <td colspan="2" class="table-cell py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div id="wishlist-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">💡 待定景點/美食/購物清單</h2>
            <p class="text-sm text-gray-600 mb-4">點擊「愛心」投票表示對該項目有興趣！</p>
            <div class="overflow-x-auto shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-16">類別</th>
                            <th class="p-3 w-40">名稱</th>
                            <th class="p-3 w-48">地點/連結</th>
                            <th class="p-3 w-20 text-center">優先級</th>
                            <th class="p-3 w-32">提議人</th>
                            <th class="p-3 w-48">備註</th>
                            <th class="p-3 w-16 text-center">❤️ 投票</th>
                            <th class="p-3 w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="wishlistBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="split-view" class="p-4 sm:p-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">💵 支出登載表</h2>
            <div class="overflow-x-auto mb-8 shadow-md rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
                            <th class="p-3 w-48">項目名稱</th>
                            <th class="p-3 w-40 text-right">金額</th>
                            <th class="p-3 w-28">幣別</th>
                            <th class="p-3 w-32">付款人</th>
                            <th class="p-3 w-40 text-right">台幣金額</th>
                            <th class="p-3 w-16">🗑️</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">⚖️ 即時結算結果</h2>
            <div id="settlement-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">🔄 轉帳清單 (誰該付誰)</h3>
            <div id="settlement-list" class="space-y-3 p-4 border rounded-lg bg-pink-50 text-gray-800"></div>
        </div>
    </div>

    <script>
        // === Firebase 配置 (請替換為您的實際配置) ===
        const firebaseConfig = {
            apiKey: "AIzaSyxxxxxxxxxxxxxxxxxxxx",
            authDomain: "japantravel-8e369.firebaseapp.com",
            databaseURL: "https://japantravel-8e369-default-rtdb.firebaseio.com",
            projectId: "japantravel-8e369",
            storageBucket: "japantravel-8e369.appspot.com",
            messagingSenderId: "xxxxxxxxxxx",
            appId: "1:xxxxxxxxxxx:web:xxxxxxxxxxxxxxxx"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // === 全域變數 ===
        let EXCHANGE_RATE = 22.50;
        const DEFAULT_PEOPLE = ['A君', 'B君', 'C君', 'D君', 'E君', 'F君'];
        let PEOPLE = DEFAULT_PEOPLE;
        
        let itineraryData = [];
        let expenses = [];
        let wishlistData = [];
        let currentPage = 'itinerary';
        let currentFilterDay = 'all'; // 追蹤當前選定的日期篩選器

        // === 即時監聽資料 ===
        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            itineraryData = data.itinerary || [];
            expenses = data.expenses || [];
            wishlistData = data.wishlist || []; 
            PEOPLE = data.people || DEFAULT_PEOPLE;
            EXCHANGE_RATE = data.rate || 22.50;
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
            
            if (currentPage === 'itinerary') {
                renderDayFilter();
                renderTable();
            }
            if (currentPage === 'split') renderSplitView();
            if (currentPage === 'wishlist') renderWishlistTable();
            
            calculateTotals(); // 計算整體總計
            calculateAndRenderSettlement();
        });

        // === 儲存資料 ===
        function saveData() {
            db.ref('/').set({
                itinerary: itineraryData,
                expenses: expenses,
                wishlist: wishlistData,
                people: PEOPLE,
                rate: EXCHANGE_RATE
            }).then(() => {
                document.getElementById('syncStatus').className = 'text-green-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = '🟢 同步成功';
            }).catch(() => {
                document.getElementById('syncStatus').className = 'text-red-600 text-xs font-semibold';
                document.getElementById('syncStatus').textContent = '🔴 同步失敗';
            });
        }

        // === 核心功能：行程表 ===

        function renderDayFilter() {
            const filterSelect = document.getElementById('dayFilter');
            
            // 找出所有不重複的日期 (YYYY-MM-DD 格式)
            const allDays = itineraryData
                .map(item => item.day)
                .filter(day => day && day.match(/^\d{4}-\d{2}-\d{2}$/)); 
            
            const uniqueDays = [...new Set(allDays)].sort();

            let options = '<option value="all">所有日期</option>';
            uniqueDays.forEach(day => {
                // 顯示為 月/日
                const displayDay = day.substring(5).replace('-', '/');
                options += `<option value="${day}" ${day === currentFilterDay ? 'selected' : ''}>${displayDay}</option>`;
            });
            
            filterSelect.innerHTML = options;

            // 如果當前篩選日期不存在於行程中，則重設為 'all'
            if (currentFilterDay !== 'all' && !uniqueDays.includes(currentFilterDay)) {
                currentFilterDay = 'all';
                filterSelect.value = 'all';
            }
        }

        function filterItinerary(selectedDay) {
            currentFilterDay = selectedDay;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('itineraryBody');
            tbody.innerHTML = '';
            
            // 1. 過濾資料
            const filteredData = itineraryData.filter(item => {
                if (currentFilterDay === 'all') return true;
                return item.day === currentFilterDay;
            });
            
            // 2. 排序資料 (依據日期 + 時間)
            filteredData.sort((a, b) => {
                const dateTimeA = (a.day || '9999-12-31') + (a.time || '23:59');
                const dateTimeB = (b.day || '9999-12-31') + (b.time || '23:59');
                if (dateTimeA < dateTimeB) return -1;
                if (dateTimeA > dateTimeB) return 1;
                return 0;
            });
            
            const columns = [
                { key: 'dateTime', class: 'font-bold w-28' }, 
                { key: 'location', editable: true, class: 'w-48' },
                { key: 'travelTime', editable: true, class: 'w-32' },
                { key: 'mapLink', editable: false, class: 'w-28' },
                { key: 'estimatedJpy', class: 'text-red-500 text-right w-32' }, 
                { key: 'notes', editable: true, isHtml: true, class: 'w-48' }
            ];

            filteredData.forEach((item, index) => {
                const originalIndex = itineraryData.findIndex(d => d === item); 

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-150'; 

                columns.forEach(field => {
                    const cell = row.insertCell();
                    cell.className = `table-cell ${field.class || ''}`;
                    
                    if (field.key === 'dateTime') {
                        let dayValue = item.day || ''; 
                        let timeValue = item.time || '';
                        
                        cell.innerHTML = `
                            <div class="date-time-container">
                                <input type="text" 
                                       id="date-${originalIndex}" 
                                       value="${dayValue}"
                                       class="flatpickr-input block text-base font-bold w-full mb-1"
                                       placeholder="月/日">
                                
                                <input type="text" 
                                       id="time-${originalIndex}" 
                                       value="${timeValue}"
                                       class="flatpickr-input block text-sm text-gray-600 w-full"
                                       placeholder="HH:MM">
                            </div>
                        `;
                        
                        // Flatpickr 初始化 (使用 originalIndex)
                        setTimeout(() => {
                            // 1. 日期選擇器 (修正: 移除 YYYY 顯示，只顯示 MM/DD)
                            flatpickr(document.getElementById(`date-${originalIndex}`), {
                                locale: 'zh-tw',
                                dateFormat: "Y-m-d", // 儲存格式 (隱藏的)
                                defaultDate: dayValue.match(/^\d{4}-\d{2}-\d{2}$/) ? dayValue : null,
                                
                                // *** 關鍵修正：確保顯示 m/d 且樣式正確 ***
                                altInput: true,
                                altFormat: "m/d", // 顯示格式 (01/30)
                                altInputClass: "flatpickr-input block text-base font-bold w-full mb-1", // 繼承原始樣式
                                
                                onChange: function(selectedDates, dateStr, instance) {
                                    itineraryData[originalIndex].day = dateStr;
                                    saveData();
                                    renderTable(); 
                                }
                            });
                            
                            // 2. 時間選擇器 (修正: 強制使用 H:i 24 小時制，移除 time_24hr 屬性)
                            flatpickr(document.getElementById(`time-${originalIndex}`), {
                                locale: 'zh-tw',
                                enableTime: true,
                                noCalendar: true,
                                
                                // *** 關鍵修正：強制 24 小時制顯示 ***
                                dateFormat: "H:i", // 儲存/內部格式 (14:00)
                                altInput: true,
                                altFormat: "H:i", // 顯示格式 (強制 24 小時制)
                                altInputClass: "flatpickr-input block text-sm text-gray-600 w-full", // 繼承原始樣式

                                onChange: function(selectedDates, dateStr, instance) {
                                    itineraryData[originalIndex].time = dateStr;
                                    saveData();
                                    renderTable(); 
                                }
                            });
                        }, 0); 
                        
                    } else if (field.key === 'estimatedJpy') {
                        // 預算欄位 (包含金額和幣別選擇)
                        const amount = item.estimatedAmount || 0; 
                        const currency = item.budgetCurrency || 'JPY';
                        
                        cell.innerHTML = `
                            <div class="flex flex-col items-end gap-1">
                                <input type="number" 
                                       value="${amount}" 
                                       min="0" 
                                       class="text-input block text-right font-semibold text-sm p-1 border-b w-full"
                                       onblur="handleBudgetAmountEdit(${originalIndex}, this.value)"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                                       placeholder="0">
                                
                                ${createCurrencySelectForBudget(originalIndex, currency)}
                            </div>
                        `;
                    } else if (field.key === 'mapLink') {
                        const url = item.mapLink || '';
                        const text = url && url !== 'https://maps.google.com' ? '🗺️ 查看' : '📍 設定';
                        cell.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <a href="${url}" target="_blank" class="text-rose-500 hover:text-rose-700 text-sm ${url ? '' : 'text-gray-400 italic'}">${text}</a>
                                <button onclick="startMapLinkEdit(${originalIndex})" class="p-1 hover:bg-rose-100 rounded-full">✏️</button>
                            </div>
                        `;
                    } 
                    else if (field.key === 'notes') {
                        let content = item[field.key] || '';
                        cell.innerHTML = content;
                        
                        if (field.editable) {
                            cell.contentEditable = true;
                            cell.onblur = (e) => handleCellEdit(originalIndex, field.key, e.target.innerHTML, false, true);
                        }
                    }
                    else {
                        let content = item[field.key] || '';
                        cell.textContent = content;
                        
                        if (field.editable) {
                            cell.contentEditable = true;
                            cell.onblur = (e) => handleCellEdit(originalIndex, field.key, e.target.innerText, false);
                        }
                    }
                });

                const delCell = row.insertCell();
                delCell.className = 'table-cell text-center';
                delCell.innerHTML = `<button onclick="deleteRow(${originalIndex})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">🗑️</button>`;
            });
            
            // 3. 計算總計
            calculateTotals(filteredData);
        }

        // 新增行程 (智慧新增邏輯)
        function addRow() {
            let newDay = new Date().toISOString().substring(0, 10);
            let newTime = "09:00";
            
            // 1. 檢查是否有日期篩選
            if (currentFilterDay !== 'all' && currentFilterDay.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // 情況一：有特定日期篩選，使用篩選日期
                newDay = currentFilterDay;
                
                // 找出該日期的所有活動 (必須有時間欄位)
                const filteredItems = itineraryData.filter(item => item.day === newDay && item.time);
                
                // 2. 判斷新行程時間
                if (filteredItems.length > 0) {
                    // 找出當天最晚的時間字串
                    const maxTimeStr = filteredItems.reduce((max, item) => {
                        return (item.time > max) ? item.time : max;
                    }, "00:00");
                    
                    // 計算新時間：最晚時間 + 30 分鐘
                    const [h, m] = maxTimeStr.split(':').map(Number);
                    
                    // 使用 Date 物件計算時間滾動（例如 23:59 + 30 分鐘）
                    // 這裡的日期只需用來計算時間滾動，不影響 day
                    let tempDate = new Date(); // 使用任意日期
                    tempDate.setFullYear(2000, 0, 1); // 確保日期是固定的
                    tempDate.setHours(h);
                    tempDate.setMinutes(m + 30); 
                    
                    // 格式化新時間回 HH:MM
                    const newH = String(tempDate.getHours()).padStart(2, '0');
                    const newM = String(tempDate.getMinutes()).padStart(2, '0');
                    newTime = `${newH}:${newM}`;
                    
                } else {
                    // 如果當天沒有活動，預設 09:00
                    newTime = "09:00";
                }
                
            } else {
                // 情況二：篩選器為 'all'，使用最後一個行程的日期
                if (itineraryData.length > 0) {
                    const lastItem = itineraryData.reduce((latest, current) => {
                        const latestDateTime = (latest.day || '0000-00-00') + (latest.time || '00:00');
                        const currentDateTime = (current.day || '0000-00-00') + (current.time || '00:00');
                        return currentDateTime > latestDateTime ? current : latest;
                    }, { day: '', time: '' });
                    
                    if (lastItem.day && lastItem.day.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        newDay = lastItem.day;
                    }
                }
                newTime = "09:00";
            }

            itineraryData.push({
                day: newDay, 
                time: newTime, 
                location: "新增地點", 
                travelTime: "", 
                mapLink: "", 
                estimatedAmount: 0, 
                budgetCurrency: 'JPY', 
                notes: "" 
            });
            saveData();
        }

        function createCurrencySelectForBudget(index, current) {
            return `
                <select onchange="handleBudgetCurrencyChange(${index}, this.value)" class="p-0 border-none rounded text-xs bg-gray-100 text-gray-700 w-full text-center">
                    <option value="JPY" ${current === 'JPY' ? 'selected' : ''}>JPY</option>
                    <option value="TWD" ${current === 'TWD' ? 'selected' : ''}>TWD</option>
                </select>
            `;
        }

        function handleBudgetAmountEdit(index, value) {
            const parsed = parseInt(value.replace(/[^0-9]/g, '')) || 0;
            itineraryData[index].estimatedAmount = parsed;
            saveData();
        }

        function handleBudgetCurrencyChange(index, currency) {
            itineraryData[index].budgetCurrency = currency;
            saveData();
        }

        function handleCellEdit(index, key, value, isBudget, isHtmlContent = false) {
            let parsed;
            
            if (isHtmlContent) {
                if (value === '<br>' || value === '<div><br></div>' || value.trim() === '') {
                    parsed = '';
                } else {
                    parsed = value;
                }
            } else {
                parsed = value.trim();
            }
            
            itineraryData[index][key] = parsed;
            saveData();
        }

        function deleteRow(index) {
            if (confirm('確定刪除此行程？')) {
                itineraryData.splice(index, 1);
                saveData();
            }
        }
        
        function calculateTotals(filteredData = itineraryData) {
            let totalJpyAll = 0;
            let totalTwdAll = 0;
            let totalJpyFiltered = 0;
            let totalTwdFiltered = 0;
            
            const calculateTwdFromBudget = (amount, currency) => {
                const num = parseInt(amount) || 0;
                return currency === 'JPY' ? Math.round(num * EXCHANGE_RATE) : num;
            };
            const calculateJpyFromBudget = (amount, currency) => {
                const num = parseInt(amount) || 0;
                return currency === 'TWD' ? Math.round(num / EXCHANGE_RATE) : num;
            };

            // 計算所有數據的總計 (整體總計)
            itineraryData.forEach(item => {
                const amount = item.estimatedAmount || 0;
                const currency = item.budgetCurrency || 'JPY';
                
                totalTwdAll += calculateTwdFromBudget(amount, currency);
                totalJpyAll += calculateJpyFromBudget(amount, currency);
            });
            
            // 計算篩選後數據的總計 (當日總計)
            filteredData.forEach(item => {
                const amount = item.estimatedAmount || 0;
                const currency = item.budgetCurrency || 'JPY';
                
                totalTwdFiltered += calculateTwdFromBudget(amount, currency);
                totalJpyFiltered += calculateJpyFromBudget(amount, currency);
            });

            // 更新上方的整體總計
            document.getElementById('totalEstimatedJpy').textContent = `${totalJpyAll.toLocaleString()} JPY`;
            document.getElementById('totalEstimatedTwd').textContent = `${totalTwdAll.toLocaleString()} TWD`;
            
            // 更新下方的篩選後總計
            document.getElementById('filteredTotalJpy').textContent = `${totalJpyFiltered.toLocaleString()} JPY`;
            document.getElementById('filteredTotalTwd').textContent = `${totalTwdFiltered.toLocaleString()} TWD`;
        }

        function startMapLinkEdit(index) {
            const row = document.querySelector(`#itineraryBody tr:nth-child(${itineraryData.findIndex(d => d === itineraryData[index]) + 1})`);
            const cell = row.cells[3]; 
            const input = document.createElement('input');
            input.type = 'url';
            input.value = itineraryData[index].mapLink || '';
            input.className = 'w-full p-1 border-2 border-rose-300 rounded'; 
            input.placeholder = '貼上Google地圖連結';
            input.onblur = () => {
                itineraryData[index].mapLink = input.value;
                saveData();
                renderTable();
            };
            input.onkeypress = (e) => e.key === 'Enter' && input.blur();
            cell.innerHTML = ''; 
            cell.appendChild(input);
            input.focus();
        }

        // === 輔助功能與分頁控制 (保持不變) ===
        function showPage(pageName) {
            currentPage = pageName;
            
            document.getElementById('itinerary-view').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-view').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-view').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-actions').classList.toggle('hidden', pageName !== 'itinerary');
            document.getElementById('split-actions').classList.toggle('hidden', pageName !== 'split');
            document.getElementById('wishlist-actions').classList.toggle('hidden', pageName !== 'wishlist');
            
            document.getElementById('itinerary-tab').className = pageName === 'itinerary' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('split-tab').className = pageName === 'split' ? 'tab tab-active' : 'tab tab-inactive';
            document.getElementById('wishlist-tab').className = pageName === 'wishlist' ? 'tab tab-active' : 'tab tab-inactive';

            if (pageName === 'split') renderSplitView();
            if (pageName === 'wishlist') renderWishlistTable();
            if (pageName === 'itinerary') renderDayFilter();
        }
        
        function updateExchangeRate(rate) {
            EXCHANGE_RATE = rate;
            document.getElementById('exchangeRate').value = rate.toFixed(2);
        }

        async function fetchExchangeRate() {
             alert("無法自動更新匯率，請手動輸入！");
        }

        // --- 待定清單功能 (略) ---
        function renderWishlistTable() {
            const tbody = document.getElementById('wishlistBody');
            tbody.innerHTML = '';
            
            wishlistData.sort((a, b) => a.priority - b.priority || a.id - b.id);

            wishlistData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.id = `wish-${item.id}`;
                row.className = 'hover:bg-gray-50';
            });
        }
        function handleWishlistCellEdit(id, key, value, isHtmlContent = false) { }
        function addWishlistItem() { }
        function deleteWishlistItem(id) { }
        function handleVote(id) { }
        function startWishlistLinkEdit(id, currentLink) { }
        function createTypeSelect(id, current) { return '';} 
        function createPrioritySelect(id, current) { return '';} 
        function createSuggestedBySelect(id, current) { return '';} 


        // --- 分帳功能 (略) ---
        function renderSplitView() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
            });
            setTimeout(() => calculateAndRenderSettlement(), 100);
        }
        function handleAmountInput(id, value) { }
        function finalizeAmountUpdate(id, value) { }
        function createCurrencySelect(id, current) { return '';}
        function createPayerSelect(id, current) { return '';}
        function updateExpenseField(id, field, value) { }
        function calculateTwdEquivalent(amount, currency) {
            const num = parseFloat(amount) || 0;
            return currency === 'JPY' ? Math.round(num * EXCHANGE_RATE) : Math.round(num);
        }
        function addExpense() { }
        function deleteExpense(id) { }
        function togglePersonEditModal() { }
        function calculateAndRenderSettlement() { }
        function renderSettlementSummary(totalTWD, sharePerPerson, netBalance) { }
        function renderSettlementList(settlements) { }
        function filterExpenses() { }

        // === 初始化 ===
        window.onload = () => {
            document.getElementById('exchangeRate').value = EXCHANGE_RATE.toFixed(2);
            showPage('itinerary');
        };
    </script>
</body>
</html>
